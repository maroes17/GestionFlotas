<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
  crossorigin="anonymous"
  type="text/javascript"
></script>
<script
  src="https://code.jquery.com/jquery-3.7.1.js"
  type="text/javascript"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/dataTables.buttons.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.dataTables.js"
  type="text/javascript"
></script>
<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.colVis.min.js"
  type="text/javascript"
></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  //Activar / Desactivar Botón Hamburguesa Menú
  const hamburger = document.querySelector("#toggle-btn");

  hamburger.addEventListener("click", function () {
    document.querySelector("#sidebar").classList.toggle("expand");
  });

  // Escuchar el click en los botones del menú
  document.querySelector("#flotaBtn").addEventListener("click", function () {
    loadTableData("Flota");
  });

  document.querySelector("#choferesBtn").addEventListener("click", function () {
    loadTableData("Choferes");
  });

  // Función para cargar los datos desde Google Sheets
  let currentSheetName = "";
  let dataTableInstance = null;

  function loadTableData(sheetName) {
    currentSheetName = sheetName;

    // Mostrar el header (ocultándolo al inicio si es necesario)
    const header = document.getElementById("table-header");
    header.style.display = "none"; // Ocultar al inicio

    // Actualizar el título
    document.getElementById("currentSectionTitle").textContent = "Cargando..."; // Mensaje de carga

    // Limpiar los botones
    const actionsDiv = document.getElementById("action-buttons");
    actionsDiv.innerHTML = "";

    // Limpiar la tabla
    const tablaPrueba = document.getElementById("tablaPrueba");
    tablaPrueba.innerHTML = "<thead></thead><tbody></tbody>";

    google.script.run
      .withSuccessHandler(function (object) {
        document.getElementById("currentSectionTitle").textContent =
          currentSheetName; // Restaurar título
        actionsDiv.innerHTML = ""; // Limpiar el "Cargando..." si lo pusiste ahí
        createActionButtons(); // Volver a crear los botones
        updateTable(object.headers, object.datos);
        header.style.display = "flex"; // Mostrar el header de nuevo
      })
      .getData(sheetName);
  }

  function createActionButtons() {
    const actionsDiv = document.getElementById("action-buttons");
    const refreshBtn = document.createElement("button");
    refreshBtn.className = "btn btn-outline-primary btn-sm me-2";
    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar';
    refreshBtn.onclick = () => {
      loadTableData(currentSheetName);
    };

    const addNewBtn = document.createElement("button");
    addNewBtn.className = "btn btn-outline-success btn-sm";
    addNewBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Agregar';
    addNewBtn.onclick = () => {
      if (currentSheetName === "Flota") {
        $("#modalAgregarFlota").modal("show");
        document.getElementById("modalAgregarFlotaLabel").textContent =
          "Agregar nuevo registro en Flota";
        document.getElementById("formAgregarFlota").reset();
      } else if (currentSheetName === "Choferes") {
        $("#modalAgregarChoferes").modal("show");
        document.getElementById("modalAgregarChoferesLabel").textContent =
          "Agregar nuevo Chofer";
        document.getElementById("formAgregarChoferes").reset();
      }
    };

    actionsDiv.appendChild(refreshBtn);
    actionsDiv.appendChild(addNewBtn);
  }

  function updateTable(headers, data) {
    // Destruir la tabla anterior si existe
    if (dataTableInstance !== null) {
      dataTableInstance.destroy();
      document.getElementById("tablaPrueba").innerHTML =
        "<thead></thead><tbody></tbody>"; // Limpiar tabla
    }

    // Formatear las columnas
    const formattedCols = headers.map((header) => {
      return { title: header };
    });

    let columnDefs = [];

    // Ocultar la columna "Creación de Registro" solo si la tabla actual es "Flota"
    if (currentSheetName === "Flota") {
      const indexCreacionRegistro = headers.indexOf("Creación de Registro");
      if (indexCreacionRegistro !== -1) {
        columnDefs.push({ targets: indexCreacionRegistro, visible: false });
      }
    }

    // Crear nueva tabla
    dataTableInstance = new DataTable("#tablaPrueba", {
      responsive: true,
      layout: {
        topStart: {
          buttons: [
            {
              extend: "colvis",
              text: "Columnas",
            },
          ],
        },
      },
      language: {
        url: "//cdn.datatables.net/plug-ins/2.2.2/i18n/es-CL.json",
      },
      columns: formattedCols,
      data: data,
      columnDefs: columnDefs, // Aplicar la definición de columnas
    });
  }

  // Funciones para actualizar el modelo en el modal de Flota
  function actualizarModeloFlota() {
    const marca = document.getElementById("inputMarcaFlota").value;
    const modeloSelect = document.getElementById("inputModeloFlota");
    modeloSelect.innerHTML = "";
    let modelos = [];
    if (marca === "Freightliner") modelos = ["Cascadia", "M2 106", "Columbia"];
    else if (marca === "International")
      modelos = ["ProStar", "LT Series", "PayStar"];
    else if (marca === "Kenworth") modelos = ["T680", "W990", "T880"];
    else if (marca === "Mack Trucks")
      modelos = ["Anthem", "Granite", "Pinnacle"];
    modelos.forEach(function (modelo) {
      const option = document.createElement("option");
      option.value = modelo;
      option.textContent = modelo;
      modeloSelect.appendChild(option);
    });
  }

  // Función para guardar un nuevo registro de Flota
  document.getElementById("btnGuardarFlota").onclick = function() {
    const tipo = document.getElementById("inputTipoFlota").value;
    const patente = document.getElementById("inputPatenteFlota").value;
    const nroChasis = document.getElementById("inputNroChasisFlota").value;
    const marca = document.getElementById("inputMarcaFlota").value;
    const modelo = document.getElementById("inputModeloFlota").value;
    const año = document.getElementById("inputAñoFlota").value;
    const fechaIngreso = document.getElementById("inputFechaIngresoFlota").value;
    const observaciones = document.getElementById("inputObservacionesFlota").value;
    const capacidad = document.getElementById("inputCapacidadFlota").value; // Permitimos que esté vacío

    // Validar campos obligatorios
    if (!tipo || !patente || !nroChasis || !marca || !modelo || !año || !fechaIngreso) {
      Swal.fire({
        icon: 'error',
        title: 'Campos Obligatorios',
        text: 'Por favor, completa todos los campos obligatorios.',
        confirmButtonColor: '#dc3545',
        confirmButtonText: 'Entendido'
      });
      return; // Detener la ejecución si hay campos vacíos
    }

    google.script.run.withSuccessHandler(function(idFlota) {
      const registro = [
        idFlota,
        tipo,
        patente,
        nroChasis,
        marca,
        modelo,
        año,
        capacidad,
        "Disponible",
        fechaIngreso,
        observaciones,
        "Creación de Registro"
      ];

      google.script.run.withSuccessHandler(function() {
        $('#modalAgregarFlota').modal('hide');
        Swal.fire({
          icon: 'success',
          title: 'Registro guardado',
          text: '¡El nuevo registro de flota se ha guardado correctamente!',
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'OK'
        });
        loadTableData(currentSheetName);
      }).agregarRegistroFlota(registro);
    }).generarIdFlota();
  };

  // Función para guardar un nuevo Chofer
  document.getElementById("btnGuardarChoferes").onclick = function () {
    const nombre = document.getElementById("inputNombreChofer").value;
    const apellido = document.getElementById("inputApellidoChofer").value;
    const licencia = document.getElementById("inputLicenciaChofer").value;

    const registroChofer = [nombre, apellido, licencia];

    google.script.run
      .withSuccessHandler(function () {
        $("#modalAgregarChoferes").modal("hide");
        Swal.fire({
          icon: "success",
          title: "Chofer guardado",
          text: "¡El nuevo chofer se ha guardado correctamente!",
          confirmButtonColor: "#3085d6",
          confirmButtonText: "OK",
        });
        loadTableData(currentSheetName);
      })
      .agregarRegistroChofer(registroChofer); // Necesitas crear esta función en code.gs
  };
</script>
