<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
  crossorigin="anonymous"
  type="text/javascript"
></script>

<script
  src="https://code.jquery.com/jquery-3.7.1.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/dataTables.buttons.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.colVis.min.js"
  type="text/javascript"
></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  //Activar / Desactivar Bot√≥n Hamburguesa Men√∫

  // Variables globales
  let currentSheetName = "";
  let dataTableInstance = null;
  const loadingModal = new bootstrap.Modal(
    document.getElementById("loadingModal")
  );

  // Funci√≥n para mostrar loading
  function showLoading(message = "Procesando...") {
    document.getElementById("loadingModal").querySelector("p").textContent =
      message;
    loadingModal.show();
  }

  // Funci√≥n para ocultar loading
  function hideLoading() {
    loadingModal.hide();
  }

  // Activar/Desactivar Bot√≥n Hamburguesa Men√∫
  document.querySelector("#toggle-btn").addEventListener("click", function () {
    document.querySelector("#sidebar").classList.toggle("expand");
  });

  // Eventos del men√∫
  document
    .querySelector("#flotaBtn")
    .addEventListener("click", () => loadTableData("Flota"));
  document
    .querySelector("#choferesBtn")
    .addEventListener("click", () => loadTableData("Choferes"));

  // Funci√≥n optimizada para cargar datos
  async function loadTableData(sheetName) {
    const cardsContainer = document.getElementById("cards-choferes");
    if (sheetName === "Choferes") {
      cardsContainer.style.display = "flex"; // Mostrar
      await mostrarCardsChoferes();
    } else {
      cardsContainer.style.display = "none"; // Ocultar
      cardsContainer.innerHTML = ""; // Limpiar contenido
    }

    try {
      currentSheetName = sheetName;
      const header = document.getElementById("table-header");
      const actionsDiv = document.getElementById("action-buttons");
      const tablaPrueba = document.getElementById("tablaPrueba");

      // Mostrar estado de carga
      header.style.display = "flex";
      document.getElementById(
        "currentSectionTitle"
      ).textContent = `Cargando ${sheetName}...`;
      actionsDiv.innerHTML = "";
      tablaPrueba.innerHTML =
        '<tr><td class="text-center py-5" colspan="100%">Cargando datos... <div class="spinner-border spinner-border-sm ms-2" role="status"><span class="visually-hidden">Cargando...</span></div></td></tr>';

      // Cargar datos con manejo de errores
      const object = await new Promise((resolve, reject) => {
        google.script.run
          .withFailureHandler(reject)
          .withSuccessHandler(resolve)
          .getData(sheetName);
      });

      // Actualizar UI con los datos
      document.getElementById("currentSectionTitle").textContent = sheetName;
      createActionButtons();
      if (sheetName === "Choferes") {
        await mostrarCardsChoferes();
      }
      updateTable(object.headers, object.datos);
    } catch (error) {
      console.error("Error al cargar datos:", error);
      document.getElementById(
        "currentSectionTitle"
      ).textContent = `Error al cargar ${sheetName}`;
      document.getElementById("tablaPrueba").innerHTML =
        '<tr><td class="text-center py-5" colspan="100%">Error al cargar los datos. Por favor, intenta nuevamente.</td></tr>';
      createActionButtons();
    }
  }

  // Funci√≥n optimizada para crear botones de acci√≥n
  function createActionButtons() {
    const actionsDiv = document.getElementById("action-buttons");
    actionsDiv.innerHTML = "";

    // Bot√≥n Actualizar
    const refreshBtn = createButton(
      "btn-outline-primary",
      "bi-arrow-clockwise",
      "Actualizar",
      () => {
        loadTableData(currentSheetName);
      }
    );

    // Bot√≥n Agregar
    const addNewBtn = createButton(
      "btn-outline-success",
      "bi-plus-circle",
      "Agregar",
      () => {
        if (currentSheetName === "Flota") {
          showAddModal("modalAgregarFlota", "Agregar nuevo registro en Flota");
        } else if (currentSheetName === "Choferes") {
          showAddModal("modalAgregarChofer", "Agregar nuevo Chofer");
        }
      }
    );

    actionsDiv.append(refreshBtn, addNewBtn);
  }

  // Helper para crear botones
  function createButton(btnClass, iconClass, text, onClick) {
    const btn = document.createElement("button");
    btn.className = `btn ${btnClass} btn-sm me-2`;
    btn.innerHTML = `<i class="bi ${iconClass}"></i> ${text}`;
    btn.onclick = onClick;
    return btn;
  }

  // Mostrar modal de agregar
  function showAddModal(modalId, title) {
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    document.getElementById(`${modalId}Label`).textContent = title;
    document.getElementById(modalId.replace("modal", "form")).reset();

    // üî• Solo si abrimos el Modal Agregar Chofer, cargamos las patentes
    if (modalId === "modalAgregarChofer") {
      cargarOpcionesFlota();
    }

    modal.show();
  }
  // Funci√≥n optimizada para actualizar la tabla
  function updateTable(headers, data) {
    // Destruir tabla anterior si existe
    if (dataTableInstance) {
      dataTableInstance.destroy();
      document.getElementById("tablaPrueba").innerHTML = "";
    }

    // Configuraci√≥n base de DataTable
    const baseConfig = {
      responsive: true,
      language: { url: "//cdn.datatables.net/plug-ins/2.2.2/i18n/es-CL.json" },
      layout: {
        topStart: { buttons: [{ extend: "colvis", text: "Columnas" }] },
      },
    };

    if (currentSheetName === "Flota" || currentSheetName === "Choferes") {
      const columnDefs = getCustomColumnDefs(headers);
      const formattedCols = headers.map((header) => ({ title: header }));
      formattedCols.push({ title: "Acciones", orderable: false }); // üëà Agregar columna Acciones

      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data.map((row) => [...row, ""]), // üëà Agregar columna vac√≠a para Acciones
        columns: formattedCols,
        columnDefs: columnDefs,
        createdRow: function (row, data) {
          $(row).attr("data-id", data[0]); // ID Chofer
        },
      });

      // Manejo de eventos optimizado
      setupFlotaTableEvents();
    } else {
      // Configuraci√≥n para otras tablas
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data,
        columns: headers.map((header) => ({ title: header })),
      });
    }
  }

  // Obtener definiciones de columnas para Flota
  function getFlotaColumnDefs(headers) {
    const columnDefs = [];
    const hiddenColumns = ["Creaci√≥n de Registro", "Fecha de Ingreso"];

    hiddenColumns.forEach((colName) => {
      const index = headers.indexOf(colName);
      if (index !== -1) columnDefs.push({ targets: index, visible: false });
    });

    // Columna de acciones
    columnDefs.push({
      targets: -1,
      render: (data, type, row) => `
        <button class="btn btn-sm btn-warning me-1 btn-editar-flota" data-id="${row[0]}" title="Editar">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger btn-borrar-flota" data-id="${row[0]}" title="Borrar">
          <i class="bi bi-trash"></i>
        </button>
      `,
    });

    return columnDefs;
  }

  // Configurar eventos de la tabla Flota
  function setupFlotaTableEvents() {
    $(document)
      .off("click", ".btn-editar-flota")
      .on("click", ".btn-editar-flota", async function () {
        const idFlota = $(this).data("id");
        $(this).find("i").addClass("spin-icon");

        try {
          const registro = await new Promise((resolve, reject) => {
            google.script.run
              .withFailureHandler(reject)
              .withSuccessHandler(resolve)
              .obtenerRegistroFlota(idFlota);
          });

          if (registro) {
            llenarModalEditarFlota(registro);
            new bootstrap.Modal(
              document.getElementById("modalEditarFlota")
            ).show();
          } else {
            Swal.fire("Error", "Registro no encontrado", "error");
          }
        } catch (error) {
          console.error("Error al editar:", error);
          Swal.fire("Error", error.message || "Error al cargar datos", "error");
        } finally {
          $(this).find("i").removeClass("spin-icon");
        }
      });

    $(document)
      .off("click", ".btn-borrar-flota")
      .on("click", ".btn-borrar-flota", function () {
        const idFlota = $(this).data("id");

        Swal.fire({
          title: "¬øEst√°s seguro?",
          text: `Se borrar√° el registro con ID: ${idFlota}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "S√≠, borrar",
          cancelButtonText: "Cancelar",
        }).then((result) => {
          if (result.isConfirmed) {
            showLoading("Borrando registro...");
            google.script.run
              .withSuccessHandler(() => {
                hideLoading(); // Ocultar spinner al √©xito
                Swal.fire(
                  "Borrado!",
                  "Registro eliminado correctamente",
                  "success"
                );
                loadTableData(currentSheetName);
              })
              .withFailureHandler((error) => {
                console.error("Error al borrar:", error);
                hideLoading(); // Ocultar spinner al error
                Swal.fire("Error", "No se pudo borrar el registro", "error");
              })
              .borrarRegistroFlota(idFlota);
          }
        });
      });
  }

  // [Mant√©n tus funciones actualizarModeloFlota, llenarModalEditarFlota, etc. aqu√≠...]
  // Solo aseg√∫rate de que usen las mismas optimizaciones de manejo de errores y async/await

  // Funci√≥n optimizada para guardar nuevo registro
  document.getElementById("btnGuardarEditarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;

    try {
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

      if (!validarFormularioFlota("formEditarFlota")) return;

      const idFlota = document.getElementById("editarIdFlota").value;
      const tipo = document.getElementById("editarTipoFlota").value;
      const patente = document
        .getElementById("editarPatenteFlota")
        .value.trim()
        .toUpperCase();
      const nroChasis = document
        .getElementById("editarNroChasisFlota")
        .value.trim();
      const marca = document.getElementById("editarMarcaFlota").value;
      const modelo = document.getElementById("editarModeloFlota").value;
      const a√±o = document.getElementById("editarA√±oFlota").value;
      const capacidad = document.getElementById("editarCapacidadFlota").value;
      const estado = document.getElementById("editarEstadoFlota").value;
      const fechaIngreso = document.getElementById(
        "editarFechaIngresoFlota"
      ).value;
      const observaciones = document.getElementById(
        "editarObservacionesFlota"
      ).value;

      const registroModificado = [
        idFlota,
        tipo,
        patente,
        nroChasis,
        marca,
        modelo,
        a√±o,
        capacidad,
        estado,
        fechaIngreso,
        observaciones,
        "Actualizaci√≥n de Registro",
      ];

      const resultado = await runGoogleFunction(
        "actualizarRegistroFlota",
        registroModificado
      );

      if (resultado === "success") {
        $("#modalEditarFlota").modal("hide");

        await Swal.fire({
          icon: "success",
          title: "Actualizado",
          text: "El registro fue actualizado correctamente",
          timer: 1500,
          showConfirmButton: false,
        });

        await loadTableData(currentSheetName);
      } else {
        throw new Error("No se pudo actualizar en el backend.");
      }
    } catch (error) {
      console.error("Error al guardar cambios:", error);
      Swal.fire({
        icon: "error",
        title: "Error al actualizar",
        text: error.message || "No se pudo actualizar correctamente",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  // Helper para obtener datos del formulario
  function getFormData(formId) {
    const form = document.getElementById(formId);
    const data = {};

    form.querySelectorAll("input, select, textarea").forEach((field) => {
      if (field.id) {
        const key = field.id.replace(/^input|^editar/, "").toLowerCase();
        data[key] = field.value.trim();
      }
    });

    return data;
  }

  // Funci√≥n de validaci√≥n de formulario
  function validarFormularioFlota(formId) {
    const form = document.getElementById(formId);
    let isValid = true;

    // Validar campos requeridos
    Array.from(form.querySelectorAll("[required]")).forEach((field) => {
      if (!field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Validaci√≥n especial para patente
    const patenteField = form.querySelector('[name*="Patente"]');
    if (patenteField && !/^[A-Z]{2}\d{3}[A-Z]{2}$/i.test(patenteField.value)) {
      patenteField.classList.add("is-invalid");
      isValid = false;

      const feedback = patenteField.nextElementSibling;
      if (feedback && feedback.classList.contains("invalid-feedback")) {
        feedback.textContent = "Formato de patente inv√°lido (ej: AB123CD)";
      }
    }

    return isValid;
  }

  // Funciones para actualizar el modelo en el modal de Flota

  function actualizarModeloFlota() {
    const marca = document.getElementById("inputMarcaFlota").value;

    const modeloSelect = document.getElementById("inputModeloFlota");

    modeloSelect.innerHTML = "";

    let modelos = [];

    if (marca === "Freightliner") modelos = ["Cascadia", "M2 106", "Columbia"];
    else if (marca === "International")
      modelos = ["ProStar", "LT Series", "PayStar"];
    else if (marca === "Kenworth") modelos = ["T680", "W990", "T880"];
    else if (marca === "Mack Trucks")
      modelos = ["Anthem", "Granite", "Pinnacle"];

    modelos.forEach(function (modelo) {
      const option = document.createElement("option");

      option.value = modelo;

      option.textContent = modelo;

      modeloSelect.appendChild(option);
    });
  }

  // Funci√≥n para guardar un nuevo registro de Flota

  document.getElementById("btnGuardarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

    try {
      if (!validarFormularioFlota("formAgregarFlota")) {
        return;
      }

      // üîµ Aqu√≠ capturamos todos los datos autom√°ticamente
      const formData = getFormData("formAgregarFlota");

      const patenteExiste = await runGoogleFunction(
        "verificarPatenteFlota",
        formData.patente
      );

      if (patenteExiste) {
        await Swal.fire({
          icon: "warning",
          title: "Patente Duplicada",
          text: "La patente ya existe en el sistema.",
          confirmButtonColor: "#ffc107",
        });
        return;
      }

      const idFlota = await runGoogleFunction("generarIdFlota");

      const registro = [
        idFlota,
        formData.tipo,
        formData.patente,
        formData.nrochasis,
        formData.marca,
        formData.modelo,
        formData.a√±o,
        formData.capacidad,
        formData.estado,
        formData.fechaingreso,
        formData.observaciones,
        "Creaci√≥n de Registro",
      ];

      await runGoogleFunction("agregarRegistroFlota", registro);

      $("#modalAgregarFlota").modal("hide");

      await Swal.fire({
        icon: "success",
        title: "Guardado",
        text: "El registro se ha guardado correctamente",
        timer: 1500,
        showConfirmButton: false,
      });

      await loadTableData(currentSheetName);
    } catch (error) {
      console.error("Error al guardar:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: error.message || "Error al guardar registro",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  // ... (resto de tu c√≥digo js.html) ...

  function llenarModalEditarFlota(registro) {
    try {
      // Cargar valores b√°sicos
      document.getElementById("editarIdFlota").value = registro[0];
      document.getElementById("editarTipoFlota").value = registro[1];
      document.getElementById("editarPatenteFlota").value = registro[2];
      document.getElementById("editarNroChasisFlota").value = registro[3];
      document.getElementById("editarMarcaFlota").value = registro[4];

      // Actualizar modelos seg√∫n marca
      actualizarModelo("editarMarcaFlota", "editarModeloFlota");

      document.getElementById("editarModeloFlota").value = registro[5];
      document.getElementById("editarA√±oFlota").value = registro[6];
      document.getElementById("editarCapacidadFlota").value = registro[7];

      // üî• Cargar Estado correctamente
      document.getElementById("editarEstadoFlota").value = registro[8];

      // Formatear y cargar Fecha de Ingreso
      let fechaIngreso = registro[9];

      if (fechaIngreso instanceof Date) {
        fechaIngreso = fechaIngreso.toISOString().split("T")[0];
      } else if (typeof fechaIngreso === "string") {
        // Arreglar fecha tipo "10/4/2025 20:00:00"
        const partes = fechaIngreso.split(" ")[0].split("/");
        if (partes.length === 3) {
          const [dia, mes, a√±o] = partes;
          fechaIngreso = `${a√±o.padStart(4, "0")}-${mes.padStart(
            2,
            "0"
          )}-${dia.padStart(2, "0")}`;
        } else {
          fechaIngreso = "";
        }
      }

      document.getElementById("editarFechaIngresoFlota").value = fechaIngreso;

      // Observaciones
      document.getElementById("editarObservacionesFlota").value = registro[10];
    } catch (error) {
      console.error("Error al llenar modal de edici√≥n:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "No se pudieron cargar los datos para editar.",
      });
    }
  }

  // Event listener para el bot√≥n "Guardar Cambios" del modal de Editar Flota

  document.getElementById("btnGuardarEditarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;

    try {
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

      if (!validarFormularioFlota("formEditarFlota")) return;

      // üîµ CORREGIDO: convertir idFlota a n√∫mero
      const idFlota = Number(document.getElementById("editarIdFlota").value);
      const tipo = document.getElementById("editarTipoFlota").value;
      const patente = document
        .getElementById("editarPatenteFlota")
        .value.trim()
        .toUpperCase();
      const nroChasis = document
        .getElementById("editarNroChasisFlota")
        .value.trim();
      const marca = document.getElementById("editarMarcaFlota").value;
      const modelo = document.getElementById("editarModeloFlota").value;
      const a√±o = document.getElementById("editarA√±oFlota").value;
      const capacidad = document.getElementById("editarCapacidadFlota").value;
      const estado = document.getElementById("editarEstadoFlota").value;
      const fechaIngreso = document.getElementById(
        "editarFechaIngresoFlota"
      ).value;
      const observaciones = document.getElementById(
        "editarObservacionesFlota"
      ).value;

      const registroModificado = [
        idFlota,
        tipo,
        patente,
        nroChasis,
        marca,
        modelo,
        a√±o,
        capacidad,
        estado,
        fechaIngreso,
        observaciones,
        "Actualizaci√≥n de Registro",
      ];

      const resultado = await runGoogleFunction(
        "actualizarRegistroFlota",
        registroModificado
      );

      if (resultado === "success") {
        $("#modalEditarFlota").modal("hide");

        await Swal.fire({
          icon: "success",
          title: "Actualizado",
          text: "El registro fue actualizado correctamente",
          timer: 1500,
          showConfirmButton: false,
        });

        await loadTableData(currentSheetName);
      } else {
        throw new Error("La actualizaci√≥n no fue exitosa.");
      }
    } catch (error) {
      console.error("Error al guardar cambios:", error);
      Swal.fire({
        icon: "error",
        title: "Error al actualizar",
        text: error.message || "Ocurri√≥ un error al actualizar el registro.",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  /**
   * Ejecuta funciones de Apps Script como promesas (async/await)
   * @param {string} functionName - Nombre de la funci√≥n GAS
   * @param {...any} params - Par√°metros que recibe
   * @returns {Promise<any>} - Resultado o error
   */
  function runGoogleFunction(functionName, ...params) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        [functionName](...params);
    });
  }

  /**
   * Valida los campos requeridos de un formulario
   * @param {string} formId
   * @returns {boolean}
   */
  function validarFormulario(formId) {
    const form = document.getElementById(formId);
    let isValid = true;

    form.querySelectorAll("[required]").forEach((field) => {
      if (!field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Validaciones especiales
    const patenteField = form.querySelector(
      "#inputPatenteFlota, #editarPatenteFlota"
    );
    if (patenteField && !/^[A-Z0-9]{5,8}$/i.test(patenteField.value.trim())) {
      patenteField.classList.add("is-invalid");
      Swal.fire("Error", "Formato de patente inv√°lido", "error");
      isValid = false;
    }

    const a√±oField = form.querySelector("#inputA√±oFlota, #editarA√±oFlota");
    if (a√±oField) {
      const a√±o = parseInt(a√±oField.value);
      const currentYear = new Date().getFullYear();
      if (isNaN(a√±o) || a√±o < 1960 || a√±o > currentYear) {
        a√±oField.classList.add("is-invalid");
        Swal.fire("Error", `A√±o debe ser entre 1960 y ${currentYear}`, "error");
        isValid = false;
      }
    }

    const capacidadField = form.querySelector(
      "#inputCapacidadFlota, #editarCapacidadFlota"
    );
    if (capacidadField && capacidadField.value <= 0) {
      capacidadField.classList.add("is-invalid");
      Swal.fire("Error", "Capacidad debe ser mayor a 0", "error");
      isValid = false;
    }

    return isValid;
  }

  const modelosPorMarca = {
    Freightliner: ["Cascadia", "M2 106", "Columbia"],
    International: ["ProStar", "LT Series", "PayStar", "9800", "7600"],
    Kenworth: ["T680", "W990", "T880", "T800"],
    "Mack Trucks": ["Anthem", "Granite", "Pinnacle", "CXU613E"],
  };

  /**
   * Actualiza opciones de modelo seg√∫n la marca
   * @param {string} marcaId - ID del select de marca
   * @param {string} modeloId - ID del select de modelo
   */
  function actualizarModelo(marcaId, modeloId) {
    const marca = document.getElementById(marcaId).value;
    const modeloSelect = document.getElementById(modeloId);
    modeloSelect.innerHTML = "";

    (modelosPorMarca[marca] || []).forEach((modelo) => {
      const option = document.createElement("option");
      option.value = modelo;
      option.textContent = modelo;
      modeloSelect.appendChild(option);
    });
  }

  //-------------------------------------------
  //Guardar Chofer
  //-------------------------------------------
  document.getElementById("btnGuardarChofer").onclick = async function () {
    try {
      const formData = getFormData("formAgregarChofer");
      const idChofer = await runGoogleFunction("generarIdChofer");

      // Capturar imagen (si existe)
      const fileInput = document.getElementById("inputFotoChofer"); // o 'editarFotoChofer'
      const file = fileInput.files[0];

      if (file) {
        let fileName = file.name;
        if (!fileName) {
          // üî• Si no existe nombre, lo generamos
          fileName = `foto_chofer_${Date.now()}.png`;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
          const base64Data = e.target.result.split(",")[1];
          const fotoUrl = await runGoogleFunction(
            "subirFotoChofer",
            base64Data,
            fileName
          );

          // Ahora armar el registro completo, incluyendo la foto
          const registro = [
            idChofer,
            formData.nombrechofer,
            formData.dnichofer,
            formData.licenciachofer,
            formData.tipolicenciachofer,
            formData.vencimientolicenciachofer,
            formData.telefonochofer,
            formData.emailchofer,
            formData.fechaingresochofer,
            formData.estadochofer,
            formData.asignadoflotachofer,
            formData.observacioneschofer,
            fotoUrl, // Agregamos URL de foto como √∫ltima columna
          ];

          await runGoogleFunction("agregarRegistroChofer", registro);

          // Cerrar modal y recargar
          const modalElement = document.getElementById("modalAgregarChofer");
          const modalInstance =
            bootstrap.Modal.getInstance(modalElement) ||
            new bootstrap.Modal(modalElement);
          modalInstance.hide();

          Swal.fire("Guardado", "Chofer agregado exitosamente", "success");
          await loadTableData("Choferes");
          console.log("Nuevo chofer registrado:", registro);
        };
        reader.readAsDataURL(file);
      } else {
        // Si no hay imagen, guardar registro sin foto
        const registro = [
          idChofer,
          formData.nombrechofer,
          formData.dnichofer,
          formData.licenciachofer,
          formData.tipolicenciachofer,
          formData.vencimientolicenciachofer,
          formData.telefonochofer,
          formData.emailchofer,
          formData.fechaingresochofer,
          formData.estadochofer,
          formData.asignadoflotachofer,
          formData.observacioneschofer,
          "", // Campo de foto vac√≠o
        ];

        await runGoogleFunction("agregarRegistroChofer", registro);

        const modalElement = document.getElementById("modalAgregarChofer");
        const modalInstance =
          bootstrap.Modal.getInstance(modalElement) ||
          new bootstrap.Modal(modalElement);
        modalInstance.hide();

        Swal.fire("Guardado", "Chofer agregado exitosamente", "success");
        await loadTableData("Choferes");
        console.log("Nuevo chofer registrado:", registro);
      }
    } catch (error) {
      console.error("Error al guardar chofer:", error);
      Swal.fire("Error", "No se pudo guardar el chofer.", "error");
    }
  };

  // Funci√≥n para llenar el Modal Editar Chofer
  function llenarModalEditarChofer(registro) {
    document.getElementById("editarIdChofer").value = registro[0];
    document.getElementById("editarNombreChofer").value = registro[1];
    document.getElementById("editarDniChofer").value = registro[2];
    document.getElementById("editarLicenciaChofer").value = registro[3];
    document.getElementById("editarTipoLicenciaChofer").value = registro[4];

    let vencLicencia = registro[5];
    if (vencLicencia) {
      vencLicencia = vencLicencia.split("T")[0];
    }
    document.getElementById("editarVencimientoLicenciaChofer").value =
      vencLicencia || "";

    document.getElementById("editarTelefonoChofer").value = registro[6];
    document.getElementById("editarEmailChofer").value = registro[7];

    let fechaIngreso = registro[8];
    if (fechaIngreso) {
      fechaIngreso = fechaIngreso.split("T")[0];
    }
    document.getElementById("editarFechaIngresoChofer").value =
      fechaIngreso || "";

    document.getElementById("editarEstadoChofer").value = registro[9];

    // Asignado a Flota (llenar din√°micamente)
    cargarOpcionesFlotaEditar(registro[0]).then(() => {
      document.getElementById("editarAsignadoFlotaChofer").value = registro[10];
    });

    document.getElementById("editarObservacionesChofer").value = registro[11];
  }

  // Funci√≥n para cargar patentes en Editar Chofer
  async function cargarOpcionesFlotaEditar(idChoferEditar) {
    const { datos: datosFlota } = await runGoogleFunction("getData", "Flota");
    const { datos: datosChoferes } = await runGoogleFunction(
      "getData",
      "Choferes"
    );

    const selectFlota = document.getElementById("editarAsignadoFlotaChofer");
    selectFlota.innerHTML =
      '<option value="">Seleccione flota disponible</option>';

    // 1. Patentes disponibles
    const patentesDisponibles = datosFlota
      .filter((row) => row[8] && row[8].trim().toLowerCase() === "disponible")
      .map((row) => row[2]); // Columna patente

    // 2. Patentes ya asignadas
    const patentesAsignadas = datosChoferes
      .filter((row) => String(row[0]) !== String(idChoferEditar)) // ‚ö° Excluir el chofer que estamos editando
      .map((row) => row[10]) // Asignado a Flota
      .filter((patente) => patente);

    // 3. Patentes libres
    const patentesLibres = patentesDisponibles.filter(
      (patente) => !patentesAsignadas.includes(patente)
    );

    patentesLibres.forEach((patente) => {
      const option = document.createElement("option");
      option.value = patente;
      option.textContent = patente;
      selectFlota.appendChild(option);
    });
  }

  // Evento bot√≥n Editar Chofer
  $(document)
    .off("click", ".btn-editar-chofer")
    .on("click", ".btn-editar-chofer", async function () {
      const idChofer = $(this).data("id");
      try {
        const registro = await runGoogleFunction(
          "obtenerRegistroChofer",
          idChofer
        );
        if (registro) {
          llenarModalEditarChofer(registro);
          const modal = new bootstrap.Modal(
            document.getElementById("modalEditarChofer")
          );
          modal.show();
        } else {
          Swal.fire("Error", "No se encontr√≥ el chofer.", "error");
        }
      } catch (error) {
        console.error("Error al cargar chofer:", error);
        Swal.fire("Error", "No se pudo cargar el chofer.", "error");
      }
    });

  // Evento bot√≥n Guardar Cambios Chofer
  document.getElementById("btnGuardarEditarChofer").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

        const formData = getFormData("formEditarChofer");

        // Capturar imagen (si existe)
        const fileInput = document.getElementById("editarFotoChofer");
        const file = fileInput.files[0];
        if (file) {
          let fileName = file.name;
          if (!fileName) {
            // üî• Si no existe nombre, lo generamos
            fileName = `foto_chofer_${Date.now()}.png`;
          }

          const reader = new FileReader();
          reader.onload = async function (e) {
            const base64Data = e.target.result.split(",")[1];
            const fotoUrl = await runGoogleFunction(
              "subirFotoChofer",
              base64Data,
              fileName
            );

            // Construir registro modificado incluyendo nueva foto
            const registroModificado = [
              Number(formData.idchofer),
              formData.nombrechofer,
              formData.dnichofer,
              formData.licenciachofer,
              formData.tipolicenciachofer,
              formData.vencimientolicenciachofer,
              formData.telefonochofer,
              formData.emailchofer,
              formData.fechaingresochofer,
              formData.estadochofer,
              formData.asignadoflotachofer,
              formData.observacioneschofer,
              fotoUrl, // URL nueva de foto
            ];

            const resultado = await runGoogleFunction(
              "actualizarRegistroChofer",
              registroModificado
            );

            if (resultado === "success") {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("modalEditarChofer")
              );
              modal.hide();
              Swal.fire(
                "Guardado",
                "Cambios actualizados correctamente.",
                "success"
              );
              await loadTableData("Choferes");
            } else {
              throw new Error("No se pudo actualizar el registro");
            }
          };
          reader.readAsDataURL(file);
        } else {
          // No hay nueva imagen subida: no cambiar foto
          const registroModificado = [
            Number(formData.idchofer),
            formData.nombrechofer,
            formData.dnichofer,
            formData.licenciachofer,
            formData.tipolicenciachofer,
            formData.vencimientolicenciachofer,
            formData.telefonochofer,
            formData.emailchofer,
            formData.fechaingresochofer,
            formData.estadochofer,
            formData.asignadoflotachofer,
            formData.observacioneschofer,
            formData.fotochofer, // Mantener el mismo URL anterior
          ];

          const resultado = await runGoogleFunction(
            "actualizarRegistroChofer",
            registroModificado
          );

          if (resultado === "success") {
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("modalEditarChofer")
            );
            modal.hide();
            Swal.fire(
              "Guardado",
              "Cambios actualizados correctamente.",
              "success"
            );
            await loadTableData("Choferes");
          } else {
            throw new Error("No se pudo actualizar el registro");
          }
        }
      } catch (error) {
        console.error("Error al actualizar:", error);
        Swal.fire(
          "Error",
          error.message || "No se pudo actualizar correctamente",
          "error"
        );
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  // Evento bot√≥n Borrar Chofer
  $(document)
    .off("click", ".btn-borrar-chofer")
    .on("click", ".btn-borrar-chofer", function () {
      const idChofer = $(this).data("id");

      Swal.fire({
        title: "¬øEst√°s seguro?",
        text: `Se eliminar√° el chofer con ID: ${idChofer}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "S√≠, borrar",
        cancelButtonText: "Cancelar",
      }).then(async (result) => {
        if (result.isConfirmed) {
          await runGoogleFunction("borrarRegistroChofer", idChofer);
          Swal.fire("¬°Borrado!", "Chofer eliminado correctamente.", "success");
          await loadTableData("Choferes");
        }
      });
    });

  // MOSTRAR CARDS CHOFERES
  function getCustomColumnDefs(headers) {
    const columnDefs = [];
    const hiddenColumns = [];

    hiddenColumns.forEach((colName) => {
      const index = headers.indexOf(colName);
      if (index !== -1) columnDefs.push({ targets: index, visible: false });
    });

    // üî• Columna de acciones al final
    columnDefs.push({
      targets: -1,
      render: (data, type, row) => {
        if (currentSheetName === "Flota") {
          return `
          <button class="btn btn-sm btn-warning me-1 btn-editar-flota" data-id="${row[0]}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger btn-borrar-flota" data-id="${row[0]}" title="Borrar">
            <i class="bi bi-trash"></i>
          </button>
        `;
        } else if (currentSheetName === "Choferes") {
          return `
          <button class="btn btn-sm btn-warning me-1 btn-editar-chofer" data-id="${row[0]}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger btn-borrar-chofer" data-id="${row[0]}" title="Borrar">
            <i class="bi bi-trash"></i>
          </button>
        `;
        }
        return "";
      },
    });

    return columnDefs;
  }

  async function mostrarCardsChoferes() {
    const container = document.getElementById("cards-choferes");
    container.innerHTML = ""; // Limpiar antes

    const { datos } = await runGoogleFunction("getData", "Choferes");

    datos.forEach((chofer) => {
      const estado = (chofer[9] || "").toLowerCase();
      const asignadoFlota = chofer[10];

      if (
        estado === "en viaje" ||
        (asignadoFlota && asignadoFlota.trim() !== "")
      ) {
        const card = document.createElement("div");
        card.className = "col-md-3";

        card.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${
            chofer[12] ||
            "https://cdn-icons-png.flaticon.com/512/1077/1077114.png"
          }" class="card-img-top" alt="Foto Chofer">

          <div class="card-body">
            <h5 class="card-title">${chofer[1] || "Sin Nombre"}</h5>
            <p class="card-text">
              <strong>Licencia:</strong> ${chofer[3] || "-"}<br>
              <strong>Estado:</strong> ${chofer[9] || "-"}<br>
              <strong>Flota:</strong> ${chofer[10] || "-"}
            </p>
          </div>
        </div>
      `;

        container.appendChild(card);
      }
    });
  }
</script>
