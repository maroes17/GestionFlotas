<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
  crossorigin="anonymous"
  type="text/javascript"
></script>

<script
  src="https://code.jquery.com/jquery-3.7.1.js"
  type="text/javascript"
></script>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/dataTables.buttons.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.colVis.min.js"
  type="text/javascript"
></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  //Activar / Desactivar Botón Hamburguesa Menú

  // Variables globales
  let currentSheetName = "";
  let dataTableInstance = null;
  const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

  // Función para mostrar loading
  function showLoading(message = "Procesando...") {
    document.getElementById('loadingModal').querySelector('p').textContent = message;
    loadingModal.show();
  }

  // Función para ocultar loading
  function hideLoading() {
    loadingModal.hide();
  }

  // Activar/Desactivar Botón Hamburguesa Menú
  document.querySelector("#toggle-btn").addEventListener("click", function() {
    document.querySelector("#sidebar").classList.toggle("expand");
  });

  // Eventos del menú
  document.querySelector("#flotaBtn").addEventListener("click", () => loadTableData("Flota"));
  document.querySelector("#choferesBtn").addEventListener("click", () => loadTableData("Choferes"));

  // Función optimizada para cargar datos
  async function loadTableData(sheetName) {
    try {
      currentSheetName = sheetName;
      const header = document.getElementById("table-header");
      const actionsDiv = document.getElementById("action-buttons");
      const tablaPrueba = document.getElementById("tablaPrueba");
      
      // Mostrar estado de carga
      header.style.display = "flex";
      document.getElementById("currentSectionTitle").textContent = `Cargando ${sheetName}...`;
      actionsDiv.innerHTML = "";
      tablaPrueba.innerHTML = '<tr><td class="text-center py-5" colspan="100%">Cargando datos... <div class="spinner-border spinner-border-sm ms-2" role="status"><span class="visually-hidden">Cargando...</span></div></td></tr>';

      // Cargar datos con manejo de errores
      const object = await new Promise((resolve, reject) => {
        google.script.run
          .withFailureHandler(reject)
          .withSuccessHandler(resolve)
          .getData(sheetName);
      });

      // Actualizar UI con los datos
      document.getElementById("currentSectionTitle").textContent = sheetName;
      createActionButtons();
      updateTable(object.headers, object.datos);
      
    } catch (error) {
      console.error("Error al cargar datos:", error);
      document.getElementById("currentSectionTitle").textContent = `Error al cargar ${sheetName}`;
      document.getElementById("tablaPrueba").innerHTML = '<tr><td class="text-center py-5" colspan="100%">Error al cargar los datos. Por favor, intenta nuevamente.</td></tr>';
      createActionButtons();
    }
  }

  // Función optimizada para crear botones de acción
  function createActionButtons() {
    const actionsDiv = document.getElementById("action-buttons");
    actionsDiv.innerHTML = '';

    // Botón Actualizar
    const refreshBtn = createButton('btn-outline-primary', 'bi-arrow-clockwise', 'Actualizar', () => {
      loadTableData(currentSheetName);
    });

    // Botón Agregar
    const addNewBtn = createButton('btn-outline-success', 'bi-plus-circle', 'Agregar', () => {
      if (currentSheetName === "Flota") {
        showAddModal('modalAgregarFlota', 'Agregar nuevo registro en Flota');
      } else if (currentSheetName === "Choferes") {
        showAddModal('modalAgregarChoferes', 'Agregar nuevo Chofer');
      }
    });

    actionsDiv.append(refreshBtn, addNewBtn);
  }

  // Helper para crear botones
  function createButton(btnClass, iconClass, text, onClick) {
    const btn = document.createElement("button");
    btn.className = `btn ${btnClass} btn-sm me-2`;
    btn.innerHTML = `<i class="bi ${iconClass}"></i> ${text}`;
    btn.onclick = onClick;
    return btn;
  }

  // Mostrar modal de agregar
  function showAddModal(modalId, title) {
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    document.getElementById(`${modalId}Label`).textContent = title;
    document.getElementById(modalId.replace('modal', 'form')).reset();
    modal.show();
  }

  // Función optimizada para actualizar la tabla
  function updateTable(headers, data) {
    // Destruir tabla anterior si existe
    if (dataTableInstance) {
      dataTableInstance.destroy();
      document.getElementById("tablaPrueba").innerHTML = '';
    }

    // Configuración base de DataTable
    const baseConfig = {
      responsive: true,
      language: { url: "//cdn.datatables.net/plug-ins/2.2.2/i18n/es-CL.json" },
      layout: {
        topStart: { buttons: [{ extend: "colvis", text: "Columnas" }] }
      }
    };

    if (currentSheetName === "Flota") {
      // Configuración específica para Flota
      const columnDefs = getFlotaColumnDefs(headers);
      const formattedCols = headers.map(header => ({ title: header }));
      formattedCols.push({ title: "Acciones", orderable: false });

      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data.map(row => [...row, '']), // Añadir columna vacía para acciones
        columns: formattedCols,
        columnDefs: columnDefs,
        createdRow: function(row, data) {
          $(row).attr('data-id', data[0]); // Agregar ID como atributo
        }
      });

      // Manejo de eventos optimizado
      setupFlotaTableEvents();
    } else {
      // Configuración para otras tablas
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data,
        columns: headers.map(header => ({ title: header }))
      });
    }
  }

  // Obtener definiciones de columnas para Flota
  function getFlotaColumnDefs(headers) {
    const columnDefs = [];
    const hiddenColumns = ["Creación de Registro", "Fecha de Ingreso"];
    
    hiddenColumns.forEach(colName => {
      const index = headers.indexOf(colName);
      if (index !== -1) columnDefs.push({ targets: index, visible: false });
    });

    // Columna de acciones
    columnDefs.push({
      targets: -1,
      render: (data, type, row) => `
        <button class="btn btn-sm btn-warning me-1 btn-editar-flota" data-id="${row[0]}" title="Editar">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger btn-borrar-flota" data-id="${row[0]}" title="Borrar">
          <i class="bi bi-trash"></i>
        </button>
      `
    });

    return columnDefs;
  }

  // Configurar eventos de la tabla Flota
  function setupFlotaTableEvents() {
    $(document)
      .off('click', '.btn-editar-flota')
      .on('click', '.btn-editar-flota', async function() {
        const idFlota = $(this).data('id');
        $(this).find('i').addClass('spin-icon');
        
        try {
          const registro = await new Promise((resolve, reject) => {
            google.script.run
              .withFailureHandler(reject)
              .withSuccessHandler(resolve)
              .obtenerRegistroFlota(idFlota);
          });

          if (registro) {
            llenarModalEditarFlota(registro);
            new bootstrap.Modal(document.getElementById('modalEditarFlota')).show();
          } else {
            Swal.fire('Error', 'Registro no encontrado', 'error');
          }
        } catch (error) {
          console.error('Error al editar:', error);
          Swal.fire('Error', error.message || 'Error al cargar datos', 'error');
        } finally {
          $(this).find('i').removeClass('spin-icon');
        }
      });

    $(document)
      .off('click', '.btn-borrar-flota')
      .on('click', '.btn-borrar-flota', function() {
        const idFlota = $(this).data('id');
        
        Swal.fire({
          title: '¿Estás seguro?',
          text: `Se borrará el registro con ID: ${idFlota}`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, borrar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            showLoading('Borrando registro...');
            google.script.run
              .withSuccessHandler(() => {
                Swal.fire('Borrado!', 'Registro eliminado correctamente', 'success');
                loadTableData(currentSheetName);
              })
              .withFailureHandler(error => {
                console.error('Error al borrar:', error);
                Swal.fire('Error', 'No se pudo borrar el registro', 'error');
              })
              .borrarRegistroFlota(idFlota)
              .finally(hideLoading);
          }
        });
      });
  }

  // [Mantén tus funciones actualizarModeloFlota, llenarModalEditarFlota, etc. aquí...]
  // Solo asegúrate de que usen las mismas optimizaciones de manejo de errores y async/await

  // Función optimizada para guardar nuevo registro
  document.getElementById("btnGuardarFlota").onclick = async function() {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

    try {
      // Validar formulario primero
      if (!validarFormularioFlota('formAgregarFlota')) {
        return;
      }

      // Obtener valores del formulario
      const formData = getFormData('formAgregarFlota');
      
      // Verificar patente
      const patenteExiste = await new Promise((resolve, reject) => {
        google.script.run
          .withFailureHandler(reject)
          .withSuccessHandler(resolve)
          .verificarPatenteFlota(formData.patente);
      });

      if (patenteExiste) {
        throw new Error('La patente ya existe en el sistema');
      }

      // Generar ID y guardar
      const idFlota = await new Promise((resolve, reject) => {
        google.script.run
          .withFailureHandler(reject)
          .withSuccessHandler(resolve)
          .generarIdFlota();
      });

      const registro = [
        idFlota,
        formData.tipo,
        formData.patente,
        formData.nroChasis,
        formData.marca,
        formData.modelo,
        formData.año,
        formData.capacidad,
        'Disponible',
        formData.fechaIngreso,
        formData.observaciones,
        'Creación de Registro'
      ];

      await new Promise((resolve, reject) => {
        google.script.run
          .withFailureHandler(reject)
          .withSuccessHandler(resolve)
          .agregarRegistroFlota(registro);
      });

      // Éxito
      $('#modalAgregarFlota').modal('hide');
      Swal.fire('Éxito', 'Registro guardado correctamente', 'success');
      loadTableData(currentSheetName);

    } catch (error) {
      console.error('Error al guardar:', error);
      Swal.fire('Error', error.message || 'Error al guardar el registro', 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  };

  // Helper para obtener datos del formulario
  function getFormData(formId) {
    const form = document.getElementById(formId);
    const data = {};
    
    Array.from(form.elements).forEach(element => {
      if (element.name) {
        data[element.name.replace('input', '').replace('Flota', '').toLowerCase()] = element.value;
      }
    });
    
    return data;
  }

  // Función de validación de formulario
  function validarFormularioFlota(formId) {
    const form = document.getElementById(formId);
    let isValid = true;

    // Validar campos requeridos
    Array.from(form.querySelectorAll('[required]')).forEach(field => {
      if (!field.value.trim()) {
        field.classList.add('is-invalid');
        isValid = false;
      } else {
        field.classList.remove('is-invalid');
      }
    });

    // Validación especial para patente
    const patenteField = form.querySelector('[name*="Patente"]');
    if (patenteField && !/^[A-Z]{2}\d{3}[A-Z]{2}$/i.test(patenteField.value)) {
      patenteField.classList.add('is-invalid');
      isValid = false;
      
      const feedback = patenteField.nextElementSibling;
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = 'Formato de patente inválido (ej: AB123CD)';
      }
    }

    return isValid;
  }

  // Funciones para actualizar el modelo en el modal de Flota

  function actualizarModeloFlota() {
    const marca = document.getElementById("inputMarcaFlota").value;

    const modeloSelect = document.getElementById("inputModeloFlota");

    modeloSelect.innerHTML = "";

    let modelos = [];

    if (marca === "Freightliner") modelos = ["Cascadia", "M2 106", "Columbia"];
    else if (marca === "International")
      modelos = ["ProStar", "LT Series", "PayStar"];
    else if (marca === "Kenworth") modelos = ["T680", "W990", "T880"];
    else if (marca === "Mack Trucks")
      modelos = ["Anthem", "Granite", "Pinnacle"];

    modelos.forEach(function (modelo) {
      const option = document.createElement("option");

      option.value = modelo;

      option.textContent = modelo;

      modeloSelect.appendChild(option);
    });
  }

  // Función para guardar un nuevo registro de Flota

  document.getElementById("btnGuardarFlota").onclick = function () {
    const btnGuardar = this;

    const textoOriginal = btnGuardar.textContent;

    btnGuardar.disabled = true;

    btnGuardar.textContent = "Cargando...";

    const tipo = document.getElementById("inputTipoFlota").value;

    const patente = document
      .getElementById("inputPatenteFlota")
      .value.trim()
      .toUpperCase();

    const nroChasis = document
      .getElementById("inputNroChasisFlota")
      .value.trim();

    const marca = document.getElementById("inputMarcaFlota").value;

    const modelo = document.getElementById("inputModeloFlota").value;

    const año = document.getElementById("inputAñoFlota").value;

    const fechaIngreso = document.getElementById(
      "inputFechaIngresoFlota"
    ).value;

    const observaciones = document.getElementById(
      "inputObservacionesFlota"
    ).value;

    const capacidad = document.getElementById("inputCapacidadFlota").value;

    // Validar campos obligatorios

    if (
      !tipo ||
      !patente ||
      !nroChasis ||
      !marca ||
      !modelo ||
      !año ||
      !fechaIngreso
    ) {
      Swal.fire({
        icon: "error",

        title: "Campos Obligatorios",

        text: "Por favor, completa todos los campos obligatorios.",

        confirmButtonColor: "#dc3545",

        confirmButtonText: "Entendido",
      }).finally(() => {
        btnGuardar.disabled = false;

        btnGuardar.textContent = textoOriginal;
      });

      return;
    }

    // Verificar si la patente ya existe (llamada al backend)

    google.script.run
      .withSuccessHandler(function (patenteExiste) {
        if (patenteExiste) {
          Swal.fire({
            icon: "warning",

            title: "Patente Duplicada",

            text: "La patente ingresada ya existe en la base de datos.",

            confirmButtonColor: "#ffc107",

            confirmButtonText: "Entendido",
          }).finally(() => {
            btnGuardar.disabled = false;

            btnGuardar.textContent = textoOriginal;
          });

          return; // Detener el guardado si la patente ya existe
        } else {
          // La patente no existe, proceder a guardar

          const gsRunner = google.script.run; // Almacenamos google.script.run en una variable

          gsRunner
            .withSuccessHandler(function (idFlota) {
              const registro = [
                idFlota,

                tipo,

                patente,

                nroChasis,

                marca,

                modelo,

                año,

                capacidad,

                "Disponible",

                fechaIngreso,

                observaciones,

                "Creación de Registro",
              ];

              gsRunner
                .withSuccessHandler(function () {
                  $("#modalAgregarFlota").modal("hide");

                  Swal.fire({
                    icon: "success",

                    title: "Registro guardado",

                    text: "¡El nuevo registro de flota se ha guardado correctamente!",

                    confirmButtonColor: "#3085d6",

                    confirmButtonText: "OK",
                  }).finally(() => {
                    btnGuardar.disabled = false;

                    btnGuardar.textContent = textoOriginal;
                  });

                  loadTableData(currentSheetName);
                })
                .agregarRegistroFlota(registro);
            })
            .withFailureHandler((error) => {
              // <-- Asegurándonos que esté aquí

              console.error("Error al generar ID:", error);

              Swal.fire({
                icon: "error",

                title: "Error al generar ID",

                text: "Hubo un problema al generar el ID del registro. Por favor, intenta nuevamente.",

                confirmButtonColor: "#dc3545",

                confirmButtonText: "Entendido",
              }).finally(() => {
                btnGuardar.disabled = false;

                btnGuardar.textContent = textoOriginal;
              });
            })
            .generarIdFlota(); // Llamamos a la función usando la variable
        }
      })
      .verificarPatenteFlota(patente)

      .withFailureHandler((error) => {
        console.error("Error al verificar patente:", error);

        Swal.fire({
          icon: "error",

          title: "Error al verificar patente",

          text: "Hubo un problema al verificar la patente. Por favor, intenta nuevamente.",

          confirmButtonColor: "#dc3545",

          confirmButtonText: "Entendido",
        }).finally(() => {
          btnGuardar.disabled = false;

          btnGuardar.textContent = textoOriginal;
        });
      });
  };

  // ... (resto de tu código js.html) ...

  function llenarModalEditarFlota(registro) {
  try {
    document.getElementById("editarIdFlota").value = registro[0];
    document.getElementById("editarTipoFlota").value = registro[1];
    document.getElementById("editarPatenteFlota").value = registro[2];
    document.getElementById("editarNroChasisFlota").value = registro[3];
    document.getElementById("editarMarcaFlota").value = registro[4];

    // Actualizar modelos
    const marcaSeleccionada = registro[4];
    const modeloSelect = document.getElementById("editarModeloFlota");
    modeloSelect.innerHTML = "";
    
    let modelos = [];
    if (marcaSeleccionada === "Freightliner") modelos = ["Argosy", "CASC 125"];
    else if (marcaSeleccionada === "International") modelos = ["7600", "9800", "9200","Prostar"];
    else if (marcaSeleccionada === "Kenworth") modelos = ["T800", "W990", "T880"];
    else if (marcaSeleccionada === "Mack Trucks") modelos = ["CXU613E", "Pinnacle"];

    modelos.forEach(modelo => {
      const option = document.createElement("option");
      option.value = option.textContent = modelo;
      modeloSelect.appendChild(option);
    });
    
    document.getElementById("editarModeloFlota").value = registro[5];
    document.getElementById("editarAñoFlota").value = registro[6];
    document.getElementById("editarCapacidadFlota").value = registro[7];
    
    // Manejo especial para fecha
    let fechaIngreso = registro[9];
    if (fechaIngreso instanceof Date) {
      fechaIngreso = fechaIngreso.toISOString().split('T')[0];
    } else if (typeof fechaIngreso === 'string') {
      fechaIngreso = fechaIngreso.split('T')[0];
    }
    document.getElementById("editarFechaIngresoFlota").value = fechaIngreso;
    
    document.getElementById("editarObservacionesFlota").value = registro[10];
  } catch (error) {
    console.error("Error al llenar modal de edición:", error);
    throw error;
  }
}

  // Event listener para el botón "Guardar Cambios" del modal de Editar Flota

  document.getElementById("btnGuardarEditarFlota").onclick = async function() {
    const btnGuardarEditar = this;
    const textoOriginal = btnGuardarEditar.textContent;
    
    try {
        btnGuardarEditar.disabled = true;
        btnGuardarEditar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

        // Validar formulario primero
        if (!validarFormularioFlota('formEditarFlota')) {
            return;
        }

        // Obtener datos del formulario
        const idFlota = document.getElementById("editarIdFlota").value;
        const tipo = document.getElementById("editarTipoFlota").value;
        const patente = document.getElementById("editarPatenteFlota").value.trim().toUpperCase();
        const nroChasis = document.getElementById("editarNroChasisFlota").value.trim();
        const marca = document.getElementById("editarMarcaFlota").value;
        const modelo = document.getElementById("editarModeloFlota").value;
        const año = document.getElementById("editarAñoFlota").value;
        const capacidad = document.getElementById("editarCapacidadFlota").value;
        const fechaIngreso = document.getElementById("editarFechaIngresoFlota").value;
        const observaciones = document.getElementById("editarObservacionesFlota").value;

        const registroModificado = [
            idFlota,
            tipo,
            patente,
            nroChasis,
            marca,
            modelo,
            año,
            capacidad,
            "Disponible",
            fechaIngreso,
            observaciones,
            "Actualización de Registro" // Cambiamos este valor para tracking
        ];

        // Enviar cambios al backend
        const resultado = await new Promise((resolve, reject) => {
            google.script.run
                .withFailureHandler(reject)
                .withSuccessHandler(resolve)
                .actualizarRegistroFlota(registroModificado);
        });

        if (resultado === "success") {
            // Cerrar modal
            $("#modalEditarFlota").modal("hide");
            
            // Mostrar notificación
            await Swal.fire({
                title: "¡Actualizado!",
                text: "Los cambios se guardaron correctamente",
                icon: "success",
                confirmButtonColor: "#3085d6",
                timer: 2000
            });

            // Forzar recarga de datos y reinicio de DataTable
            await loadTableData(currentSheetName);
            
        } else {
            throw new Error("No se pudo actualizar el registro");
        }
    } catch (error) {
        console.error("Error al guardar cambios:", error);
        Swal.fire({
            title: "Error",
            text: error.message || "Ocurrió un error al guardar los cambios",
            icon: "error",
            confirmButtonColor: "#dc3545"
        });
    } finally {
        btnGuardarEditar.disabled = false;
        btnGuardarEditar.textContent = textoOriginal;
    }
};

  function actualizarModeloEditarFlota() {
        const marca = document.getElementById("editarMarcaFlota").value;

        const modeloSelect = document.getElementById("editarModeloFlota");

        modeloSelect.innerHTML = "";

        let modelos = [];

        if (marca === "Freightliner")
          modelos = ["Cascadia", "M2 106", "Columbia"];
        else if (marca === "International")
          modelos = ["ProStar", "LT Series", "PayStar"];
        else if (marca === "Kenworth") modelos = ["T680", "W990", "T880"];
        else if (marca === "Mack Trucks")
          modelos = ["Anthem", "Granite", "Pinnacle"];

        modelos.forEach(function (modelo) {
          const option = document.createElement("option");

          option.value = modelo;

          option.textContent = modelo;

          modeloSelect.appendChild(option);
        });
      }

  // ... (resto de tu código js.html) ...
</script>