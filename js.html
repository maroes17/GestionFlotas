<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq"
  crossorigin="anonymous"
  type="text/javascript"
></script>

<script
  src="https://code.jquery.com/jquery-3.7.1.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/dataTables.responsive.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/responsive/3.0.4/js/responsive.bootstrap5.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/dataTables.buttons.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.dataTables.js"
  type="text/javascript"
></script>

<script
  src="https://cdn.datatables.net/buttons/3.2.2/js/buttons.colVis.min.js"
  type="text/javascript"
></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  //Activar / Desactivar Botón Hamburguesa Menú

  // Variables globales
  let currentSheetName = "";
  let dataTableInstance = null;
  let listenerTipoPolizaAgregado = false;
  const cacheDatosPorModulo = {};
  const loadingModal = new bootstrap.Modal(
    document.getElementById("loadingModal")
  );

  // 📅 Formatear fecha DD-MM-YYYY ➔ YYYY-MM-DD (para usar en inputs de fecha)
  function formatearFechaParaInput(fechaTexto) {
    if (!fechaTexto || !fechaTexto.includes("-")) return "";
    const partes = fechaTexto.split("-");
    if (partes.length === 3) {
      const [dia, mes, anio] = partes;
      return `${anio}-${mes}-${dia}`;
    }
    return "";
  }

  // 📅 Función para formatear fecha YYYY-MM-DD ➔ DD-MM-YYYY
  function formatearFecha(fechaISO) {
    if (!fechaISO || !fechaISO.includes("-")) return "";
    const [anio, mes, dia] = fechaISO.split("-");
    return `${dia.padStart(2, "0")}-${mes.padStart(2, "0")}-${anio}`;
  }

  // 🔵 Función para calcular días por vencer licencia
  function calcularDiasPorVencer(fechaLicencia) {
    if (!fechaLicencia) return "-";
    const vencimiento = new Date(fechaLicencia);
    const hoy = new Date();
    const diferencia = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
    return diferencia >= 0 ? `${diferencia} días` : "Vencida";
  }

  // 🔵 Función para calcular antigüedad del chofer
  function calcularAntiguedad(fechaIngreso) {
    if (!fechaIngreso) return "-";
    const ingreso = new Date(fechaIngreso);
    const hoy = new Date();
    return hoy.getFullYear() - ingreso.getFullYear();
  }

  function convertirFechaParaInput(fechaTexto) {
    if (!fechaTexto || !fechaTexto.includes("-")) return "";
    const partes = fechaTexto.split("-");
    if (partes.length === 3) {
      const [dia, mes, anio] = partes;
      return `${anio}-${mes}-${dia}`;
    }
    return "";
  }

  function limpiarMoneda(valor) {
    return valor.replace(/[^0-9]/g, ""); // Elimina CLP, $ y comas
  }

  // 🔵 Función para obtener clases CSS de acuerdo al estado
  function obtenerClasesEstado(estado) {
    switch (estado) {
      case "disponible":
        return {
          badgeClass: "estado-disponible",
          bordeClass: "borde-disponible",
        };
      case "en ruta":
        return { badgeClass: "estado-en-ruta", bordeClass: "borde-en-ruta" };
      case "licencia":
        return { badgeClass: "estado-licencia", bordeClass: "borde-licencia" };
      case "baja":
        return { badgeClass: "estado-baja", bordeClass: "borde-baja" };
      default:
        return { badgeClass: "estado-disponible", bordeClass: "" };
    }
  }

  // Función para mostrar loading
  function showLoading(message = "Procesando...") {
    document.getElementById("loadingModal").querySelector("p").textContent =
      message;
    loadingModal.show();
  }

  // Función para ocultar loading
  function hideLoading() {
    loadingModal.hide();
  }

  // Activar/Desactivar Botón Hamburguesa Menú
  document.querySelector("#toggle-btn").addEventListener("click", function () {
    document.querySelector("#sidebar").classList.toggle("expand");
  });

  // Eventos del menú
  document
    .querySelector("#flotaBtn")
    .addEventListener("click", () => loadTableData("Flota"));
  document
    .querySelector("#choferesBtn")
    .addEventListener("click", () => loadTableData("Choferes"));
  document
    .querySelector("#polizasBtn")
    .addEventListener("click", () => loadTableData("Polizas"));
  document
    .querySelector("#viajesBtn")
    .addEventListener("click", () => loadTableData("Viajes"));

  // Función optimizada para cargar datos
  async function loadTableData(sheetName) {
    const cardsContainer = document.getElementById("cards-choferes");
    const filtrosContainer = document.getElementById("filtros-choferes");
    const filtrosPolizasContainer = document.getElementById("filtros-polizas"); // ✅ nuevo
    const tablaPrueba = document.getElementById("tablaPrueba");
    const header = document.getElementById("table-header");
    const actionsDiv = document.getElementById("action-buttons");

    currentSheetName = sheetName;
    header.style.display = "flex";
    actionsDiv.innerHTML = "";

    // 🔴 Ocultar filtros de pólizas por defecto
    if (filtrosPolizasContainer) {
      filtrosPolizasContainer.style.display = "none";
      filtrosPolizasContainer.innerHTML = "";
    }

    // 🔵 Mostrar cards si es Choferes
    if (sheetName === "Choferes") {
      cardsContainer.style.display = "flex";
      tablaPrueba.style.display = "none";

      if (dataTableInstance) {
        dataTableInstance.destroy();
        dataTableInstance = null;
        document.getElementById("tablaPrueba").innerHTML = "";
      }

      filtrosContainer.style.display = "flex";
      filtrosContainer.innerHTML = "";
      crearFiltrosChoferes();

      document.getElementById("currentSectionTitle").textContent = "Choferes";

      if (!cacheDatosPorModulo["Choferes"]) {
        const { datos } = await runGoogleFunction("getData", "Choferes");
        cacheDatosPorModulo["Choferes"] = datos;
      }

      datosChoferes = cacheDatosPorModulo["Choferes"];
      await mostrarCardsChoferes();
    } else {
      // 🔵 Otros módulos
      cardsContainer.style.display = "none";
      if (filtrosContainer) {
        filtrosContainer.style.display = "none";
        filtrosContainer.innerHTML = "";
      }

      tablaPrueba.style.display = "table";
      cardsContainer.innerHTML = "";

      document.getElementById(
        "currentSectionTitle"
      ).textContent = `Cargando ${sheetName}...`;

      tablaPrueba.innerHTML = `
      <tr><td class="text-center py-5" colspan="100%">
      Cargando datos... <div class="spinner-border spinner-border-sm ms-2" role="status">
      <span class="visually-hidden">Cargando...</span></div></td></tr>`;

      try {
        let object;
        if (cacheDatosPorModulo[sheetName]) {
          object = {
            headers: cacheDatosPorModulo[sheetName + "_headers"],
            datos: cacheDatosPorModulo[sheetName],
          };
        } else {
          object = await runGoogleFunction("getData", sheetName);
          cacheDatosPorModulo[sheetName] = object.datos;
          cacheDatosPorModulo[sheetName + "_headers"] = object.headers;
        }

        document.getElementById("currentSectionTitle").textContent = sheetName;
        createActionButtons();
        updateTable(object.headers, object.datos);

        // ✅ Mostrar filtros solo si es sección Polizas
        if (sheetName === "Polizas") {
          crearFiltrosPolizas();
          filtrosPolizasContainer.style.display = "flex";
        }
      } catch (error) {
        console.error("Error al cargar datos:", error);
        document.getElementById(
          "currentSectionTitle"
        ).textContent = `Error al cargar ${sheetName}`;
        tablaPrueba.innerHTML = `
        <tr><td class="text-center py-5" colspan="100%">
        Error al cargar los datos. Por favor, intenta nuevamente.</td></tr>`;
      }
    }
  }

  // Función optimizada para crear botones de acción
  function createActionButtons() {
    const actionsDiv = document.getElementById("action-buttons");
    actionsDiv.innerHTML = "";

    // Botón Actualizar
    const refreshBtn = createButton(
      "btn-outline-primary",
      "bi-arrow-clockwise",
      "Actualizar",
      () => {
        cacheDatosPorModulo[currentSheetName] = null;
        cacheDatosPorModulo[`${currentSheetName}_headers`] = null;
        loadTableData(currentSheetName);
      }
    );

    // Botón Agregar
    const addNewBtn = createButton(
      "btn-outline-success",
      "bi-plus-circle",
      "Agregar",
      async () => {
        if (currentSheetName === "Viajes") {
          await showAddModal("modalAgregarViaje", "Registrar nuevo viaje");
        } else if (currentSheetName === "Choferes") {
          showAddModal("modalAgregarChofer", "Agregar nuevo Chofer");
        } else if (currentSheetName === "Semirremolque") {
          showAddModal(
            "modalAgregarSemirremolque",
            "Agregar nuevo Semirremolque"
          );
        } else if (currentSheetName === "Polizas") {
          showAddModal("modalAgregarPoliza", "Agregar nueva póliza");
        } else if (currentSheetName === "Viajes") {
          showAddModal("modalAgregarViaje", "Registrar nuevo viaje");
        }
      }
    );

    actionsDiv.append(refreshBtn, addNewBtn);
  }

  // Helper para crear botones
  function createButton(btnClass, iconClass, text, onClick) {
    const btn = document.createElement("button");
    btn.className = `btn ${btnClass} btn-sm me-2`;
    btn.innerHTML = `<i class="bi ${iconClass}"></i> ${text}`;
    btn.onclick = onClick;
    return btn;
  }

  // Mostrar modal de agregar (optimizado)
  async function showAddModal(modalId, title) {
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    document.getElementById(`${modalId}Label`).textContent = title;
    document.getElementById(modalId.replace("modal", "form")).reset();

    if (modalId === "modalAgregarChofer") {
      const select = document.getElementById("inputAsignadoFlotaChofer");
      if (select.options.length <= 1) {
        await cargarOpcionesFlota();
      }
    } else if (modalId === "modalAgregarSemirremolque") {
      await cargarOpcionesChoferesAgregar();
    } else if (modalId === "modalAgregarPoliza") {
      if (!listenerTipoPolizaAgregado) {
        document
          .getElementById("inputTipoPoliza")
          .addEventListener("change", actualizarOpcionesPatente);
        listenerTipoPolizaAgregado = true;
      }
      await actualizarOpcionesPatente();
    } else if (modalId === "modalAgregarViaje") {
      document.getElementById(modalId.replace("modal", "form")).reset();
      await llenarSelectsViaje("agregar");
      await cargarConductoresDisponiblesViaje(); // ✅ Mostrar solo disponibles
    }

    modal.show();
  }

  // Función optimizada para actualizar la tabla
  function updateTable(headers, data) {
    const actionsDiv = document.getElementById("action-buttons"); // ✅ Definir aquí para todos los casos

    // 🔵 Destruir tabla anterior si existe
    if (dataTableInstance) {
      dataTableInstance.destroy();
      document.getElementById("tablaPrueba").innerHTML = "";
    }

    // 🔵 Configuración base de DataTable
    const baseConfig = {
      responsive: true,
      language: { url: "//cdn.datatables.net/plug-ins/2.2.2/i18n/es-CL.json" },
      layout: {
        topStart: { buttons: [{ extend: "colvis", text: "Columnas" }] },
      },
    };

    // 🔵 Estructura de columnas
    const formattedCols = headers.map((header, index) => ({
      title: header,
      className: index === 0 ? "text-center" : "",
    }));

    formattedCols.push({ title: "Acciones", orderable: false });

    // 🔵 Si estamos en Flota
    if (currentSheetName === "Flota") {
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        pageLength: 50,
        data: data.map((row) => [...row, ""]),
        columns: formattedCols,
        columnDefs: getFlotaColumnDefs(headers),
        createdRow: function (row, data) {
          $(row).attr("data-id", data[0]);
        },
      });

      setupBotonesFlota();
    }

    // 🔵 Si estamos en Semirremolque
    else if (currentSheetName === "Semirremolque") {
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        pageLength: 25,
        data: data.map((row) => [...row, ""]),
        columns: formattedCols,
        columnDefs: getSemirremolqueColumnDefs(headers),
        createdRow: function (row, data) {
          $(row).attr("data-id", data[0]);
        },
      });

      setupBotonesSemirremolque();
    }

    // 🔵 Si estamos en Polizas
    else if (currentSheetName === "Polizas") {
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data.map((row) => [...row, ""]),
        columns: formattedCols,
        columnDefs: getPolizasColumnDefs(headers),
        createdRow: function (row, data) {
          $(row).attr("data-id", data[0]);
        },
      });

      setupBotonesPoliza();
    }

    // 🔵 Si estamos en Viajes
    else if (currentSheetName === "Viajes") {
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data.map((row) => [...row, ""]),
        columns: formattedCols,
        columnDefs: getViajesColumnDefs(headers),
        createdRow: function (row, data) {
          $(row).attr("data-id", data[0]);
        },
      });

      setupBotonesViaje(); // ✅ Para que funcione editar, ver más y borrar
    }

    // 🔵 Otros módulos
    else {
      dataTableInstance = new DataTable("#tablaPrueba", {
        ...baseConfig,
        data: data.map((row) => [...row, ""]),
        columns: formattedCols,
      });
    }
  }

  // Obtener definiciones de columnas para Flota
  function getFlotaColumnDefs(headers) {
    const columnDefs = [];

    // 🔵 Ocultar columna "Creación de Registro" si existe
    const creacionRegistroIndex = headers.indexOf("Creación de Registro");
    if (creacionRegistroIndex !== -1) {
      columnDefs.push({
        targets: creacionRegistroIndex,
        visible: false,
      });
    }

    // 🔵 Etiqueta de Estado
    const estadoIndex = headers.indexOf("Estado");
    if (estadoIndex !== -1) {
      columnDefs.push({
        targets: estadoIndex,
        render: function (data) {
          let badgeClass = "";
          const estado = (data || "").toLowerCase();
          switch (estado) {
            case "disponible":
              badgeClass = "estado-disponible badge-estado-flota";
              break;
            case "mantención":
              badgeClass = "estado-mantencion badge-estado-flota";
              break;
            case "siniestro":
              badgeClass = "estado-siniestro badge-estado-flota";
              break;
            case "robado":
              badgeClass = "estado-robado badge-estado-flota";
              break;
            default:
              badgeClass = "badge-estado-flota";
          }
          return `<span class="badge ${badgeClass}">${data}</span>`;
        },
      });
    }

    // 🔵 Botones de acción
    columnDefs.push({
      targets: -1,
      render: (data, type, row) => `
    <div class="d-flex justify-content-center align-items-center gap-1">
      <button class="btn btn-sm btn-warning btn-editar-flota" data-id="${row[0]}" title="Editar">
        <i class="bi bi-pencil-square"></i>
      </button>
      <button class="btn btn-sm btn-danger btn-borrar-flota" data-id="${row[0]}" title="Borrar">
        <i class="bi bi-trash"></i>
      </button>
    </div>
  `,
    });

    return columnDefs;
  }

  // [Mantén tus funciones actualizarModeloFlota, llenarModalEditarFlota, etc. aquí...]
  // Solo asegúrate de que usen las mismas optimizaciones de manejo de errores y async/await

  // Función optimizada para guardar nuevo registro
  document.getElementById("btnGuardarEditarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;

    try {
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

      if (!validarFormularioFlota("formEditarFlota")) return;

      const idFlota = document.getElementById("editarIdFlota").value;
      const tipo = document.getElementById("editarTipoFlota").value;
      const patente = document
        .getElementById("editarPatenteFlota")
        .value.trim()
        .toUpperCase();
      const nroChasis = document
        .getElementById("editarNroChasisFlota")
        .value.trim();
      const marca = document.getElementById("editarMarcaFlota").value;
      const modelo = document.getElementById("editarModeloFlota").value;
      const año = document.getElementById("editarAñoFlota").value;
      const capacidad = document.getElementById("editarCapacidadFlota").value;
      const estado = document.getElementById("editarEstadoFlota").value;
      const fechaIngreso = document.getElementById(
        "editarFechaIngresoFlota"
      ).value;
      const observaciones = document.getElementById(
        "editarObservacionesFlota"
      ).value;

      const registroModificado = [
        idFlota,
        tipo,
        patente,
        nroChasis,
        marca,
        modelo,
        año,
        capacidad,
        estado,
        fechaIngreso,
        observaciones,
        "Actualización de Registro",
      ];

      const resultado = await runGoogleFunction(
        "actualizarRegistroFlota",
        registroModificado
      );

      if (resultado === "success") {
        $("#modalEditarFlota").modal("hide");

        await Swal.fire({
          icon: "success",
          title: "Actualizado",
          text: "El registro fue actualizado correctamente",
          timer: 1500,
          showConfirmButton: false,
        });

        await loadTableData(currentSheetName);
      } else {
        throw new Error("No se pudo actualizar en el backend.");
      }
    } catch (error) {
      console.error("Error al guardar cambios:", error);
      Swal.fire({
        icon: "error",
        title: "Error al actualizar",
        text: error.message || "No se pudo actualizar correctamente",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  // Helper para obtener datos del formulario
  function getFormData(formId) {
    const form = document.getElementById(formId);
    const data = {};

    form.querySelectorAll("input, select, textarea").forEach((field) => {
      if (field.id) {
        // Evita eliminar partes críticas del ID
        const key = field.id
          .replace(/^input/, "") // Solo quitamos el prefijo "input"
          .replace(/^editar/, "") // y el "editar"
          .toLowerCase();
        data[key] = field.value.trim();
      }
    });

    return data;
  }

  // Función de validación de formulario
  function validarFormularioFlota(formId) {
    const form = document.getElementById(formId);
    let isValid = true;

    // Validar campos requeridos
    Array.from(form.querySelectorAll("[required]")).forEach((field) => {
      if (!field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Validación especial para patente
    const patenteField = form.querySelector('[name*="Patente"]');
    if (patenteField && !/^[A-Z]{2}\d{3}[A-Z]{2}$/i.test(patenteField.value)) {
      patenteField.classList.add("is-invalid");
      isValid = false;

      const feedback = patenteField.nextElementSibling;
      if (feedback && feedback.classList.contains("invalid-feedback")) {
        feedback.textContent = "Formato de patente inválido (ej: AB123CD)";
      }
    }

    return isValid;
  }

  // Funciones para actualizar el modelo en el modal de Flota

  function actualizarModeloFlota() {
    const marca = document.getElementById("inputMarcaFlota").value;

    const modeloSelect = document.getElementById("inputModeloFlota");

    modeloSelect.innerHTML = "";

    let modelos = [];

    if (marca === "Freightliner") modelos = ["Cascadia", "M2 106", "Columbia"];
    else if (marca === "International")
      modelos = ["ProStar", "LT Series", "PayStar"];
    else if (marca === "Kenworth") modelos = ["T680", "W990", "T880"];
    else if (marca === "Mack Trucks")
      modelos = ["Anthem", "Granite", "Pinnacle"];

    modelos.forEach(function (modelo) {
      const option = document.createElement("option");

      option.value = modelo;

      option.textContent = modelo;

      modeloSelect.appendChild(option);
    });
  }

  // Función para guardar un nuevo registro de Flota

  document.getElementById("btnGuardarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

    try {
      if (!validarFormularioFlota("formAgregarFlota")) return;

      const formData = getFormData("formAgregarFlota");
      const patenteNormalizada = formData.patenteflota.toUpperCase(); // ✅ siempre en mayúsculas

      const patenteExiste = await runGoogleFunction(
        "verificarPatenteFlota",
        patenteNormalizada
      );

      if (patenteExiste) {
        await Swal.fire({
          icon: "warning",
          title: "Patente Duplicada",
          text: "La patente ya existe en el sistema.",
          confirmButtonColor: "#ffc107",
        });
        return;
      }

      const idFlota = await runGoogleFunction("generarIdFlota");

      const registro = [
        idFlota,
        formData.tipoflota || "",
        patenteNormalizada, // 👈 aquí también
        formData.nrochasisflota || "",
        formData.marcaflota || "",
        formData.modeloflota || "",
        formData.añoflota || "",
        formData.capacidadflota || "",
        formData.estadoflota || "",
        formatearFecha(formData.fechaingresoflota),
        formData.observacionesflota || "",
        "Creación de Registro",
      ];

      await runGoogleFunction("agregarRegistroFlota", registro);

      $("#modalAgregarFlota").modal("hide");

      await Swal.fire({
        icon: "success",
        title: "Guardado",
        text: "El registro se ha guardado correctamente",
        timer: 1500,
        showConfirmButton: false,
      });

      cacheDatosPorModulo["Flota"] = null;
      cacheDatosPorModulo["Flota_headers"] = null;
      await loadTableData("Flota");
    } catch (error) {
      console.error("❌ Error al guardar:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: error.message || "Error al guardar registro",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  // ... (resto de tu código js.html) ...

  function llenarModalEditarFlota(registro) {
    try {
      document.getElementById("editarIdFlota").value = registro[0];
      document.getElementById("editarTipoFlota").value = registro[1];
      document.getElementById("editarPatenteFlota").value = registro[2];
      document.getElementById("editarNroChasisFlota").value = registro[3];
      document.getElementById("editarMarcaFlota").value = registro[4];

      actualizarModelo("editarMarcaFlota", "editarModeloFlota");
      document.getElementById("editarModeloFlota").value = registro[5];
      document.getElementById("editarAñoFlota").value = registro[6];
      document.getElementById("editarCapacidadFlota").value = registro[7];
      document.getElementById("editarEstadoFlota").value = registro[8];

      // 🛠 NUEVO - Cargar fecha correctamente
      let fechaIngreso = registro[9];
      if (fechaIngreso) {
        if (fechaIngreso.includes("-")) {
          // Ya viene formateada tipo DD-MM-YYYY
          fechaIngreso = formatearFechaParaInput(fechaIngreso);
        } else if (fechaIngreso instanceof Date) {
          fechaIngreso = fechaIngreso.toISOString().split("T")[0];
        }
      }
      document.getElementById("editarFechaIngresoFlota").value =
        fechaIngreso || "";

      document.getElementById("editarObservacionesFlota").value = registro[10];
    } catch (error) {
      console.error("Error al llenar modal de edición:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: "No se pudieron cargar los datos para editar.",
      });
    }
  }

  // Event listener para el botón "Guardar Cambios" del modal de Editar Flota

  document.getElementById("btnGuardarEditarFlota").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

    try {
      if (!validarFormularioFlota("formEditarFlota")) return;

      const formData = getFormData("formEditarFlota");

      const registroModificado = [
        Number(formData.idflota),
        formData.tipoflota || "",
        (formData.patenteflota || "").toUpperCase(),
        formData.nrochasisflota || "",
        formData.marcaflota || "",
        formData.modeloflota || "",
        formData.añoflota || "",
        formData.capacidadflota || "",
        formData.estadoflota || "",
        formatearFecha(formData.fechaingresoflota), // ✅ Formato corregido
        formData.observacionesflota || "",
        "Actualización de Registro",
      ];

      const resultado = await runGoogleFunction(
        "actualizarRegistroFlota",
        registroModificado
      );

      if (resultado === "success") {
        $("#modalEditarFlota").modal("hide");
        await Swal.fire({
          icon: "success",
          title: "Actualizado",
          text: "El registro fue actualizado correctamente",
          timer: 1500,
          showConfirmButton: false,
        });
        // 🔥 Agrega estas 2 líneas:
        cacheDatosPorModulo[currentSheetName] = null;
        cacheDatosPorModulo[currentSheetName + "_headers"] = null;

        await loadTableData(currentSheetName);
      } else {
        throw new Error("No se pudo actualizar en el backend.");
      }
    } catch (error) {
      console.error("❌ Error al actualizar:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: error.message || "Error al actualizar registro",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  /**
   * Ejecuta funciones de Apps Script como promesas (async/await)
   * @param {string} functionName - Nombre de la función GAS
   * @param {...any} params - Parámetros que recibe
   * @returns {Promise<any>} - Resultado o error
   */
  function runGoogleFunction(functionName, ...params) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler((error) => {
          console.error("❌ Error en función GAS:", error);
          Swal.fire("Error", "Se produjo un error en el servidor.", "error");
          reject(error);
        })
        [functionName](...params);
    });
  }

  /**
   * Valida los campos requeridos de un formulario
   * @param {string} formId
   * @returns {boolean}
   */
  function validarFormulario(formId) {
    const form = document.getElementById(formId);
    let isValid = true;

    form.querySelectorAll("[required]").forEach((field) => {
      if (!field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    // Validaciones especiales
    const patenteField = form.querySelector(
      "#inputPatenteFlota, #editarPatenteFlota"
    );
    if (patenteField && !/^[A-Z0-9]{5,8}$/i.test(patenteField.value.trim())) {
      patenteField.classList.add("is-invalid");
      Swal.fire("Error", "Formato de patente inválido", "error");
      isValid = false;
    }

    const añoField = form.querySelector("#inputAñoFlota, #editarAñoFlota");
    if (añoField) {
      const año = parseInt(añoField.value);
      const currentYear = new Date().getFullYear();
      if (isNaN(año) || año < 1960 || año > currentYear) {
        añoField.classList.add("is-invalid");
        Swal.fire("Error", `Año debe ser entre 1960 y ${currentYear}`, "error");
        isValid = false;
      }
    }

    const capacidadField = form.querySelector(
      "#inputCapacidadFlota, #editarCapacidadFlota"
    );
    if (capacidadField && capacidadField.value <= 0) {
      capacidadField.classList.add("is-invalid");
      Swal.fire("Error", "Capacidad debe ser mayor a 0", "error");
      isValid = false;
    }

    return isValid;
  }

  const modelosPorMarca = {
    Freightliner: ["Cascadia", "M2 106", "Columbia"],
    International: ["ProStar", "LT Series", "PayStar", "9800", "7600"],
    Kenworth: ["T680", "W990", "T880", "T800"],
    "Mack Trucks": ["Anthem", "Granite", "Pinnacle", "CXU613E"],
  };

  /**
   * Actualiza opciones de modelo según la marca
   * @param {string} marcaId - ID del select de marca
   * @param {string} modeloId - ID del select de modelo
   */
  function actualizarModelo(marcaId, modeloId) {
    const marca = document.getElementById(marcaId).value;
    const modeloSelect = document.getElementById(modeloId);
    modeloSelect.innerHTML = "";

    (modelosPorMarca[marca] || []).forEach((modelo) => {
      const option = document.createElement("option");
      option.value = modelo;
      option.textContent = modelo;
      modeloSelect.appendChild(option);
    });
  }

  //-------------------------------------------
  //Guardar Chofer
  //-------------------------------------------
  document.getElementById("btnGuardarChofer").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

    try {
      // 🔴 Validación personalizada
      if (!validarFormularioAgregarChofer()) {
        throw new Error("Por favor, completa los campos obligatorios.");
      }

      const formData = getFormData("formAgregarChofer");
      const idChofer = await runGoogleFunction("generarIdChofer");

      const registro = [
        idChofer,
        formData.nombrechofer,
        formData.dnichofer,
        formData.licenciachofer,
        formData.tipolicenciachofer,
        formData.vencimientolicenciachofer,
        formData.telefonochofer,
        formData.emailchofer,
        formData.fechaingresochofer,
        formData.estadochofer,
        formData.asignadoflotachofer,
        formData.observacioneschofer,
        formData.fotochofer || "",
      ];

      await runGoogleFunction("agregarRegistroChofer", registro);

      $("#modalAgregarChofer").modal("hide");

      await Swal.fire({
        icon: "success",
        title: "Guardado",
        text: "El chofer se ha guardado correctamente",
        timer: 1500,
        showConfirmButton: false,
      });

      datosChoferes = [];
      await mostrarCardsChoferes();
    } catch (error) {
      console.error("Error al guardar chofer:", error);
      Swal.fire("Error", error.message || "Error al guardar chofer", "error");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  // Función para llenar el Modal Editar Chofer
  function llenarModalEditarChofer(registro) {
    document.getElementById("editarIdChofer").value = registro[0];
    document.getElementById("editarNombreChofer").value = registro[1];
    document.getElementById("editarDniChofer").value = registro[2];
    document.getElementById("editarLicenciaChofer").value = registro[3];
    document.getElementById("editarTipoLicenciaChofer").value = registro[4];

    let vencLicencia = registro[5];
    if (vencLicencia) {
      vencLicencia = vencLicencia.split("T")[0];
    }
    document.getElementById("editarVencimientoLicenciaChofer").value =
      vencLicencia || "";

    document.getElementById("editarTelefonoChofer").value = registro[6];
    document.getElementById("editarEmailChofer").value = registro[7];

    let fechaIngreso = registro[8];
    if (fechaIngreso) {
      fechaIngreso = fechaIngreso.split("T")[0];
    }
    document.getElementById("editarFechaIngresoChofer").value =
      fechaIngreso || "";

    document.getElementById("editarEstadoChofer").value = registro[9];

    // Asignado a Flota (llenar dinámicamente)
    cargarOpcionesFlotaEditar(registro[0]).then(() => {
      document.getElementById("editarAsignadoFlotaChofer").value = registro[10];
    });

    document.getElementById("editarObservacionesChofer").value = registro[11];
  }

  // Función para cargar patentes en Editar Chofer
  async function cargarOpcionesFlotaEditar(idChoferEditar) {
    const { datos: datosFlota } = await runGoogleFunction("getData", "Flota");
    const { datos: datosChoferes } = await runGoogleFunction(
      "getData",
      "Choferes"
    );

    const selectFlota = document.getElementById("editarAsignadoFlotaChofer");
    selectFlota.innerHTML =
      '<option value="">Seleccione flota disponible</option>';

    // 1. Patentes disponibles
    const patentesDisponibles = datosFlota
      .filter((row) => row[8] && row[8].trim().toLowerCase() === "disponible")
      .map((row) => row[2]); // Columna patente

    // 2. Patentes ya asignadas
    const patentesAsignadas = datosChoferes
      .filter((row) => String(row[0]) !== String(idChoferEditar)) // ⚡ Excluir el chofer que estamos editando
      .map((row) => row[10]) // Asignado a Flota
      .filter((patente) => patente);

    // 3. Patentes libres
    const patentesLibres = patentesDisponibles.filter(
      (patente) => !patentesAsignadas.includes(patente)
    );

    patentesLibres.forEach((patente) => {
      const option = document.createElement("option");
      option.value = patente;
      option.textContent = patente;
      selectFlota.appendChild(option);
    });
  }

  // Evento botón Editar Chofer
  $(document)
    .off("click", ".btn-editar-chofer")
    .on("click", ".btn-editar-chofer", async function () {
      const idChofer = $(this).data("id");

      try {
        const registro = await runGoogleFunction(
          "obtenerRegistroChofer",
          idChofer
        );

        if (registro) {
          llenarModalEditarChofer(registro);

          const modal = new bootstrap.Modal(
            document.getElementById("modalEditarChofer")
          );
          modal.show();
        } else {
          Swal.fire("Error", "No se encontró el chofer.", "error");
        }
      } catch (error) {
        console.error("❌ Error al cargar datos del chofer:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "No se pudo cargar los datos del chofer.",
        });
      }
    });

  // Evento botón Guardar Cambios Chofer
  document.getElementById("btnGuardarEditarChofer").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

        const formData = getFormData("formEditarChofer");

        const registroModificado = [
          Number(formData.idchofer),
          formData.nombrechofer || "",
          formData.dnichofer || "",
          formData.licenciachofer || "",
          formData.tipolicenciachofer || "",
          formData.vencimientolicenciachofer || "",
          formData.telefonochofer || "",
          formData.emailchofer || "",
          formData.fechaingresochofer || "",
          formData.estadochofer || "",
          formData.asignadoflotachofer || "",
          formData.observacioneschofer || "",
          formData.fotochofer || "",
        ];

        const resultado = await runGoogleFunction(
          "actualizarRegistroChofer",
          registroModificado
        );

        if (resultado === "success") {
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("modalEditarChofer")
          );
          modal.hide();

          await Swal.fire({
            icon: "success",
            title: "Actualizado",
            text: "El chofer fue actualizado correctamente",
            timer: 1500,
            showConfirmButton: false,
          });

          // 🔥 Refrescamos correctamente los cards
          datosChoferes = []; // ⚡ Limpiar datos anteriores
          await mostrarCardsChoferes("todos", true); // ⚡ Recargar cards desde servidor
        } else {
          throw new Error("No se pudo actualizar el registro.");
        }
      } catch (error) {
        console.error("❌ Error al actualizar chofer:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "Error al actualizar el chofer",
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  // Evento botón Borrar Chofer
  $(document)
    .off("click", ".btn-borrar-chofer")
    .on("click", ".btn-borrar-chofer", function () {
      const idChofer = $(this).data("id");

      Swal.fire({
        title: "¿Estás seguro?",
        text: `Se eliminará el chofer con ID: ${idChofer}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sí, borrar",
        cancelButtonText: "Cancelar",
      }).then(async (result) => {
        if (result.isConfirmed) {
          await runGoogleFunction("borrarRegistroChofer", idChofer);
          Swal.fire("¡Borrado!", "Chofer eliminado correctamente.", "success");
          await loadTableData("Choferes");
        }
      });
    });

  // MOSTRAR CARDS CHOFERES
  function getCustomColumnDefs(headers) {
    const columnDefs = [];

    const estadoIndex = headers.indexOf("Estado");

    if (estadoIndex !== -1) {
      columnDefs.push({
        targets: estadoIndex,
        render: function (data, type, row) {
          let badgeClass = "";
          const estado = (data || "").toLowerCase();
          switch (estado) {
            case "disponible":
              badgeClass = "estado-disponible";
              break;
            case "mantención":
              badgeClass = "estado-en-ruta"; // Puedes cambiarlo por otro si quieres
              break;
            case "siniestro":
              badgeClass = "estado-licencia"; // Adaptación visual
              break;
            case "robado":
              badgeClass = "estado-baja";
              break;
            default:
              badgeClass = "estado-disponible";
          }

          return `<span class="badge ${badgeClass}">${data}</span>`;
        },
      });
    }

    // Columna de acciones
    columnDefs.push({
      targets: -1,
      render: (data, type, row) => {
        if (currentSheetName === "Flota") {
          return `
          <button class="btn btn-sm btn-warning me-1 btn-editar-flota" data-id="${row[0]}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger btn-borrar-flota" data-id="${row[0]}" title="Borrar">
            <i class="bi bi-trash"></i>
          </button>
        `;
        } else if (currentSheetName === "Choferes") {
          return `
          <button class="btn btn-sm btn-warning me-1 btn-editar-chofer" data-id="${row[0]}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger btn-borrar-chofer" data-id="${row[0]}" title="Borrar">
            <i class="bi bi-trash"></i>
          </button>
        `;
        }
        return "";
      },
    });

    return columnDefs;
  }

  //Mostrar Cards de choferes
  let datosChoferes = []; // 🔥 Variable global para almacenar los choferes cargados
  //Mostrar datosSemirremolque
  let datosSemirremolques = []; // 🔥 Variable global para almacenar los semirremolque cargados

  // 🔵 Solo carga datos si es necesario
  async function cargarDatosChoferes(force = false) {
    if (force || datosChoferes.length === 0) {
      const { datos } = await runGoogleFunction("getData", "Choferes");
      datosChoferes = datos;
      cacheDatosPorModulo["Choferes"] = datos;
    }
  }

  // 🔵 Carga de datos Info
  async function cargarDatosInfo() {
    if (!cacheDatosPorModulo["Info"]) {
      const { datos } = await runGoogleFunction("getData", "Info");
      cacheDatosPorModulo["Info"] = datos;
    }
  }

  // 🔵 Genera los cards a partir de datosChoferes
  function renderizarCardsChoferes(filtroEstado = "todos") {
    const container = document.getElementById("cards-choferes");
    container.innerHTML = "";

    actualizarContadores();

    datosChoferes.forEach((chofer) => {
      const estado = (chofer[9] || "").toLowerCase();
      if (filtroEstado === "todos" || estado === filtroEstado) {
        const foto =
          chofer[12] ||
          "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";
        const diasPorVencer = calcularDiasPorVencer(chofer[5]);
        const antiguedad = calcularAntiguedad(chofer[8]);

        const { badgeClass, bordeClass } = obtenerClasesEstado(estado);

        const card = document.createElement("div");
        card.className = "col-md-3 mb-4";
        card.innerHTML = `
        <div class="card h-100 shadow-sm card-chofer">
          <div class="card-body text-center d-flex flex-column">
            <img src='${foto}' class="card-img-top ${bordeClass}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1077/1077114.png';" alt="Foto Chofer">
            <h5 class="card-title mt-2">${chofer[1] || "Sin Nombre"}</h5>
            <span class="estado-badge ${badgeClass}">${
          chofer[9] || "Sin Estado"
        }</span>
            <p class="mt-2 mb-2 small text-muted">
              <strong>Vence Licencia:</strong> ${formatearFecha(chofer[5])}<br>
              <strong>Días por vencer:</strong> ${diasPorVencer}<br>
              <strong>Antigüedad:</strong> ${antiguedad}
            </p>
            <div class="mt-auto">
              <button class="btn btn-outline-primary btn-sm btn-ver-mas-chofer" data-id="${
                chofer[0]
              }">Ver más</button>
            </div>
          </div>
        </div>
      `;
        container.appendChild(card);
      }
    });

    // Eventos para ver más
    document.querySelectorAll(".btn-ver-mas-chofer").forEach((btn) => {
      btn.addEventListener("click", async function () {
        const id = this.getAttribute("data-id");
        await mostrarDetallesChofer(id);
      });
    });
  }

  async function mostrarCardsChoferes(filtro = "todos", force = false) {
    await cargarDatosChoferes(force);
    renderizarCardsChoferes(filtro);
  }

  // async function mostrarCardsChoferes(filtroEstado = "todos") {
  //   const container = document.getElementById("cards-choferes");
  //   container.innerHTML = "";

  //   if (datosChoferes.length === 0) {
  //     const { datos } = await runGoogleFunction("getData", "Choferes");
  //     datosChoferes = datos;
  //   }
  //   actualizarContadores();

  //   datosChoferes.forEach((chofer) => {
  //     const estado = (chofer[9] || "").toLowerCase();
  //     const asignadoFlota = chofer[10];
  //     const foto =
  //       chofer[12] || "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";

  //     if (filtroEstado === "todos" || estado === filtroEstado) {
  //       let badgeClass = "";
  //       let bordeClass = "";
  //       switch (estado) {
  //         case "disponible":
  //           badgeClass = "estado-disponible";
  //           bordeClass = "borde-disponible";
  //           break;
  //         case "en ruta":
  //           badgeClass = "estado-en-ruta";
  //           bordeClass = "borde-en-ruta";
  //           break;
  //         case "licencia":
  //           badgeClass = "estado-licencia";
  //           bordeClass = "borde-licencia";
  //           break;
  //         case "baja":
  //           badgeClass = "estado-baja";
  //           bordeClass = "borde-baja";
  //           break;
  //         default:
  //           badgeClass = "estado-disponible";
  //           bordeClass = "";
  //       }

  //       let diasPorVencer = "-";
  //       if (chofer[5]) {
  //         const vencimiento = new Date(chofer[5]);
  //         const hoy = new Date();
  //         const diferencia = Math.ceil(
  //           (vencimiento - hoy) / (1000 * 60 * 60 * 24)
  //         );
  //         diasPorVencer = diferencia >= 0 ? diferencia + " días" : "Vencida";
  //       }

  //       let edad = "-";
  //       if (chofer[8]) {
  //         const ingreso = new Date(chofer[8]);
  //         const hoy = new Date();
  //         edad = hoy.getFullYear() - ingreso.getFullYear();
  //       }

  //       const card = document.createElement("div");
  //       card.className = "col-md-3 mb-4";

  //       card.innerHTML = `
  //       <div class="card h-100 shadow-sm card-chofer">
  //         <div class="card-body text-center d-flex flex-column">
  //           <img src='${foto}' class="card-img-top ${bordeClass}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1077/1077114.png';" alt="Foto Chofer">
  //           <h5 class="card-title mt-2">${chofer[1] || "Sin Nombre"}</h5>
  //           <span class="estado-badge ${badgeClass}">${
  //         chofer[9] || "Sin Estado"
  //       }</span>

  //           <p class="mt-2 mb-2 small text-muted">
  //             <strong>Vence Licencia:</strong> ${
  //               chofer[5] ? chofer[5].split("T")[0] : "-"
  //             }<br>
  //             <strong>Días por vencer:</strong> ${diasPorVencer}<br>
  //             <strong>Edad:</strong> ${edad}
  //           </p>

  //           <div class="mt-auto">
  //             <button class="btn btn-outline-primary btn-sm btn-ver-mas-chofer" data-id="${
  //               chofer[0]
  //             }">Ver más</button>
  //           </div>
  //         </div>
  //       </div>
  //     `;

  //       container.appendChild(card);
  //     }
  //   });

  //   // Configurar eventos "Ver más"
  //   document.querySelectorAll(".btn-ver-mas-chofer").forEach((btn) => {
  //     btn.addEventListener("click", async function () {
  //       const idChofer = this.getAttribute("data-id");
  //       await mostrarDetallesChofer(idChofer);
  //     });
  //   });
  // }

  // Función para manejar el filtro
  function filtrarChoferes(estado) {
    mostrarCardsChoferes(estado);
  }

  //Mostrar Detalles Botón Mas Chofer
  async function mostrarDetallesChofer(idChofer) {
    try {
      const registro = await runGoogleFunction(
        "obtenerRegistroChofer",
        idChofer
      );

      if (!registro) {
        Swal.fire("Error", "Chofer no encontrado", "error");
        return;
      }

      // Llenar el modal
      document.getElementById("fotoVerMasChofer").src =
        registro[12] ||
        "https://cdn-icons-png.flaticon.com/512/1077/1077114.png";
      document.getElementById("nombreVerMasChofer").textContent =
        registro[1] || "Sin Nombre";
      document.getElementById("estadoVerMasChofer").textContent =
        registro[9] || "Sin Estado";

      const estadoLower = (registro[9] || "").toLowerCase();
      document.getElementById("estadoVerMasChofer").className =
        "badge estado-badge " +
        (estadoLower === "disponible"
          ? "estado-disponible"
          : estadoLower === "en ruta"
          ? "estado-en-ruta"
          : estadoLower === "licencia"
          ? "estado-licencia"
          : "estado-baja");

      document.getElementById("licenciaVerMasChofer").textContent =
        registro[3] || "-";
      document.getElementById("flotaVerMasChofer").textContent =
        registro[10] || "-";
      document.getElementById("fechaIngresoVerMasChofer").textContent =
        registro[8] || "-";
      document.getElementById("observacionesVerMasChofer").textContent =
        registro[11] || "-";

      // Configurar botones Editar / Eliminar
      document.getElementById("btnEditarChofer").onclick = () =>
        editarChoferDesdeModal(idChofer);
      document.getElementById("btnEliminarChofer").onclick = () =>
        eliminarChoferDesdeModal(idChofer);

      // Mostrar modal
      const modal = new bootstrap.Modal(
        document.getElementById("modalVerMasChofer")
      );
      modal.show();
    } catch (error) {
      console.error("Error al cargar chofer:", error);
      Swal.fire("Error", "No se pudo cargar los datos del chofer", "error");
    }
  }

  //Editar Chofer desde Modal
  async function editarChoferDesdeModal(idChofer) {
    try {
      const registro = await runGoogleFunction(
        "obtenerRegistroChofer",
        idChofer
      );

      if (!registro) {
        Swal.fire("Error", "No se encontró el chofer.", "error");
        return;
      }

      // Llenar el formulario de Editar
      document.getElementById("editarIdChofer").value = registro[0];
      document.getElementById("editarNombreChofer").value = registro[1];
      document.getElementById("editarDniChofer").value = registro[2];
      document.getElementById("editarLicenciaChofer").value = registro[3];
      document.getElementById("editarTipoLicenciaChofer").value = registro[4];
      document.getElementById("editarVencimientoLicenciaChofer").value = (
        registro[5] || ""
      ).split("T")[0];
      document.getElementById("editarTelefonoChofer").value = registro[6];
      document.getElementById("editarEmailChofer").value = registro[7];
      document.getElementById("editarFechaIngresoChofer").value = (
        registro[8] || ""
      ).split("T")[0];
      document.getElementById("editarEstadoChofer").value = registro[9];

      await cargarOpcionesFlotaEditar(registro[0]);
      document.getElementById("editarAsignadoFlotaChofer").value = registro[10];
      document.getElementById("editarObservacionesChofer").value = registro[11];
      document.getElementById("editarFotoChofer").value = registro[12] || "";

      // Cerrar Modal Ver Más
      const modalVerMas = bootstrap.Modal.getInstance(
        document.getElementById("modalVerMasChofer")
      );
      modalVerMas.hide();

      // Abrir Modal Editar
      const modalEditar = new bootstrap.Modal(
        document.getElementById("modalEditarChofer")
      );
      modalEditar.show();
    } catch (error) {
      console.error("Error al cargar chofer:", error);
      Swal.fire("Error", "No se pudo cargar el chofer para edición", "error");
    }
  }

  //Borrar Chofer desde Modal
  async function eliminarChoferDesdeModal(idChofer) {
    try {
      const confirmacion = await Swal.fire({
        title: "¿Estás seguro?",
        text: "Esta acción eliminará permanentemente al chofer.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
      });

      if (confirmacion.isConfirmed) {
        await runGoogleFunction("borrarRegistroChofer", idChofer);

        Swal.fire({
          title: "Eliminado",
          text: "El chofer fue eliminado correctamente.",
          icon: "success",
          timer: 2000,
          showConfirmButton: false,
        });

        // Cerrar el modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("modalVerMasChofer")
        );
        modal.hide();

        // Recargar Cards
        await mostrarCardsChoferes("todos", true);
      }
    } catch (error) {
      console.error("Error al eliminar chofer:", error);
      Swal.fire("Error", "No se pudo eliminar el chofer.", "error");
    }
  }

  //Cargar Opciones Flota

  async function cargarOpcionesFlota() {
    const { datos: datosFlota } = await runGoogleFunction("getData", "Flota");
    const { datos: datosChoferes } = await runGoogleFunction(
      "getData",
      "Choferes"
    );

    const selectFlota = document.getElementById("inputAsignadoFlotaChofer");
    selectFlota.innerHTML =
      '<option value="">Seleccione flota disponible</option>';

    // 1. Filtrar patentes disponibles
    const patentesDisponibles = datosFlota
      .filter((row) => row[8] && row[8].trim().toLowerCase() === "disponible")
      .map((row) => row[2]); // Columna patente

    // 2. Patentes ya asignadas a otros choferes
    const patentesAsignadas = datosChoferes
      .map((row) => row[10])
      .filter((patente) => patente);

    // 3. Mostrar solo patentes disponibles que NO estén asignadas
    const patentesLibres = patentesDisponibles.filter(
      (patente) => !patentesAsignadas.includes(patente)
    );

    patentesLibres.forEach((patente) => {
      const option = document.createElement("option");
      option.value = patente;
      option.textContent = patente;
      selectFlota.appendChild(option);
    });
  }

  //Actualizar contadores para botones de filtro
  function actualizarContadores() {
    const total = datosChoferes.length;
    const disponibles = datosChoferes.filter(
      (c) => (c[9] || "").toLowerCase() === "disponible"
    ).length;
    const enRuta = datosChoferes.filter(
      (c) => (c[9] || "").toLowerCase() === "en ruta"
    ).length;
    const licencia = datosChoferes.filter(
      (c) => (c[9] || "").toLowerCase() === "licencia"
    ).length;

    document.getElementById("btnFiltroTodos").innerHTML = `Todos (${total})`;
    document.getElementById(
      "btnFiltroDisponible"
    ).innerHTML = `Disponibles (${disponibles})`;
    document.getElementById(
      "btnFiltroEnRuta"
    ).innerHTML = `En Ruta (${enRuta})`;
    document.getElementById(
      "btnFiltroLicencia"
    ).innerHTML = `Licencia (${licencia})`;
  }

  //Crear Filtros dinamicamente para Cards Choferes
  function crearFiltrosChoferes() {
    const filtrosContainer = document.getElementById("filtros-choferes");

    filtrosContainer.innerHTML = `
    <div class="d-flex flex-wrap justify-content-center align-items-center gap-2">
      <button class="btn btn-success btn-sm" onclick="abrirModalAgregarChofer()">
        <i class="bi bi-plus-circle"></i> Agregar Chofer
      </button>

      <button id="btnFiltroTodos" class="btn btn-outline-primary btn-sm" onclick="filtrarChoferes('todos')">Todos (0)</button>
      <button id="btnFiltroDisponible" class="btn btn-outline-success btn-sm" onclick="filtrarChoferes('disponible')">Disponibles (0)</button>
      <button id="btnFiltroEnRuta" class="btn btn-outline-info btn-sm" onclick="filtrarChoferes('en ruta')">En Ruta (0)</button>
      <button id="btnFiltroLicencia" class="btn btn-outline-warning btn-sm" onclick="filtrarChoferes('licencia')">Licencia (0)</button>
    </div>
  `;

    filtrosContainer.style.display = "flex";
  }

  function abrirModalAgregarChofer() {
    const modal = new bootstrap.Modal(
      document.getElementById("modalAgregarChofer")
    );
    document.getElementById("formAgregarChofer").reset(); // Limpiar formulario
    modal.show();
  }

  function validarFormularioAgregarChofer() {
    const form = document.getElementById("formAgregarChofer");
    let isValid = true;

    // Lista de campos obligatorios
    const camposRequeridos = [
      "inputNombreChofer",
      "inputDniChofer",
      "inputLicenciaChofer",
      "inputTipoLicenciaChofer",
      "inputVencimientoLicenciaChofer",
      "inputFechaIngresoChofer",
      "inputEstadoChofer",
    ];

    camposRequeridos.forEach((id) => {
      const field = document.getElementById(id);
      if (!field || !field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    return isValid;
  }

  //------------------------------
  // Cargar módulo Semirremolque
  //------------------------------
  document
    .querySelector("#semirremolqueBtn")
    .addEventListener("click", () => loadTableData("Semirremolque"));

  // Guardar cambios de Semirremolque (Editar)
  document.getElementById("btnGuardarEditarSemirremolque").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

      try {
        // Recolección manual de campos
        const id = document.getElementById("editarIdSemirremolque").value;
        const patente = document
          .getElementById("editarPatenteSemirremolque")
          .value.trim()
          .toUpperCase(); // 🔥 AQUÍ va el cambio correcto
        const genset = document
          .getElementById("editarNroGensetSemirremolque")
          .value.trim();
        const tipo = document.getElementById("editarTipoSemirremolque").value;
        const año = document.getElementById("editarAñoSemirremolque").value;
        const estado = document.getElementById(
          "editarEstadoSemirremolque"
        ).value;
        const asignado = document.getElementById(
          "editarAsignadoChoferSemirremolque"
        ).value;
        const observaciones = document.getElementById(
          "editarObservacionesSemirremolque"
        ).value;

        const registroModificado = [
          Number(id),
          patente,
          genset,
          tipo,
          año,
          estado,
          asignado,
          observaciones,
        ];

        const resultado = await runGoogleFunction(
          "actualizarRegistroSemirremolque",
          registroModificado
        );

        if (resultado === "success") {
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("modalEditarSemirremolque")
          );
          modal.hide();

          await Swal.fire({
            icon: "success",
            title: "Actualizado",
            text: "El registro fue actualizado correctamente",
            timer: 1500,
            showConfirmButton: false,
          });

          // Refrescar tabla y limpiar caché
          cacheDatosPorModulo["Semirremolque"] = null;
          cacheDatosPorModulo["Semirremolque_headers"] = null;
          await loadTableData("Semirremolque");
        } else {
          throw new Error("No se pudo actualizar el registro");
        }
      } catch (error) {
        console.error("Error al actualizar semirremolque:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "Error al actualizar el semirremolque",
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  // Evento botón Guardar Semirremolque
  document.getElementById("btnGuardarSemirremolque").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

      try {
        // 🔴 Validación personalizada
        if (!validarFormularioAgregarSemirremolque()) {
          throw new Error("Por favor, completa los campos obligatorios.");
        }

        const formData = getFormData("formAgregarSemirremolque");

        // ✅ Normalizar la patente a mayúsculas
        const patenteNormalizada = (
          formData.patentesemirremolque || ""
        ).toUpperCase();

        const idSemirremolque = await runGoogleFunction(
          "generarIdSemirremolque"
        );

        const registro = [
          idSemirremolque,
          patenteNormalizada, // 👈 Aquí aplicamos la patente en mayúscula
          String(formData.nrogensetsemirremolque || ""),
          formData.tiposemirremolque || "",
          formData.añosemirremolque || "",
          formData.estadosemirremolque || "",
          formData.asignadochofersemirremolque || "",
          formData.observacionessemirremolque || "",
        ];

        await runGoogleFunction("agregarRegistroSemirremolque", registro);

        $("#modalAgregarSemirremolque").modal("hide");

        await Swal.fire({
          icon: "success",
          title: "Guardado",
          text: "El semirremolque se ha guardado correctamente",
          timer: 1500,
          showConfirmButton: false,
        });

        cacheDatosPorModulo["Semirremolque"] = null;
        cacheDatosPorModulo["Semirremolque_headers"] = null;
        await loadTableData("Semirremolque");
      } catch (error) {
        console.error("❌ Error al guardar semirremolque:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "Error al guardar semirremolque",
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  function getSemirremolqueColumnDefs(headers) {
    const columnDefs = [];

    // Centramos el ID (columna 0)
    columnDefs.push({
      targets: 0,
      className: "text-center",
    });

    // Centramos la columna "Nro Genset" si existe
    const nroGensetIndex = headers.indexOf("Nro Genset");
    if (nroGensetIndex !== -1) {
      columnDefs.push({
        targets: nroGensetIndex,
        className: "text-center",
      });
    }

    // Etiqueta de Estado como badge
    const estadoIndex = headers.indexOf("Estado");
    if (estadoIndex !== -1) {
      columnDefs.push({
        targets: estadoIndex,
        render: function (data) {
          let badgeClass = "";
          const estado = (data || "").toLowerCase();
          switch (estado) {
            case "disponible":
              badgeClass = "estado-disponible badge-estado-flota";
              break;
            case "mantención":
              badgeClass = "estado-mantencion badge-estado-flota";
              break;
            case "siniestro":
              badgeClass = "estado-siniestro badge-estado-flota";
              break;
            case "robado":
              badgeClass = "estado-robado badge-estado-flota";
              break;
            default:
              badgeClass = "badge-estado-flota";
          }
          return `<span class="badge ${badgeClass}">${data}</span>`;
        },
      });
    }

    // Columna Acciones (editar y borrar)
    columnDefs.push({
      targets: -1,
      orderable: false,
      render: (data, type, row) => `
      <div class="d-flex justify-content-center align-items-center gap-1">
        <button class="btn btn-sm btn-warning btn-editar-semirremolque" data-id="${row[0]}" title="Editar">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger btn-borrar-semirremolque" data-id="${row[0]}" title="Borrar">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `,
    });

    return columnDefs;
  }

  function setupBotonesSemirremolque() {
    // Botón editar
    $(document)
      .off("click", ".btn-editar-semirremolque")
      .on("click", ".btn-editar-semirremolque", async function () {
        const idSemirremolque = $(this).data("id");
        try {
          const registro = await runGoogleFunction(
            "obtenerRegistroSemirremolque",
            idSemirremolque
          );
          if (registro) {
            await llenarModalEditarSemirremolque(registro);
            const modal = new bootstrap.Modal(
              document.getElementById("modalEditarSemirremolque")
            );
            modal.show();
          } else {
            Swal.fire("Error", "Registro no encontrado", "error");
          }
        } catch (error) {
          console.error("Error al editar:", error);
          Swal.fire(
            "Error",
            error.message || "Error al cargar datos para editar.",
            "error"
          );
        }
      });

    // Botón borrar
    $(document)
      .off("click", ".btn-borrar-semirremolque")
      .on("click", ".btn-borrar-semirremolque", async function () {
        const idSemirremolque = $(this).data("id");

        const confirmacion = await Swal.fire({
          title: "¿Estás seguro?",
          text: `Se eliminará el semirremolque con ID: ${idSemirremolque}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Sí, borrar",
          cancelButtonText: "Cancelar",
        });

        if (confirmacion.isConfirmed) {
          try {
            showLoading("Eliminando...");
            await runGoogleFunction(
              "borrarRegistroSemirremolque",
              idSemirremolque
            );

            Swal.fire({
              icon: "success",
              title: "Eliminado",
              text: "Semirremolque eliminado correctamente",
              timer: 1500,
              showConfirmButton: false,
            });

            // 🔥 LIMPIAR CACHÉ y RECARGAR tabla
            cacheDatosPorModulo["Semirremolque"] = null;
            cacheDatosPorModulo["Semirremolque_headers"] = null;
            await loadTableData("Semirremolque");
          } catch (error) {
            console.error("Error al borrar:", error);
            Swal.fire("Error", "No se pudo borrar el registro.", "error");
          } finally {
            hideLoading();
          }
        }
      });
  }

  // Función para llenar el Modal de Editar Semirremolque (optimizada)
  async function llenarModalEditarSemirremolque(registro) {
    try {
      // Validar si viene registro correcto
      if (!registro || registro.length < 8) {
        throw new Error("Datos de semirremolque incompletos.");
      }

      // Asignar valores al formulario
      document.getElementById("editarIdSemirremolque").value =
        registro[0] || "";
      document.getElementById("editarPatenteSemirremolque").value =
        registro[1] || "";
      document.getElementById("editarNroGensetSemirremolque").value =
        registro[2] || "";
      document.getElementById("editarTipoSemirremolque").value =
        registro[3] || "";
      document.getElementById("editarAñoSemirremolque").value =
        registro[4] || "";
      document.getElementById("editarEstadoSemirremolque").value =
        registro[5] || "";
      document.getElementById("editarObservacionesSemirremolque").value =
        registro[7] || "";

      // 🔵 Cargar choferes disponibles, excluyendo los ya asignados (excepto el actual)
      await cargarOpcionesChoferesEditar(registro[0]);

      // Seleccionar el valor actual del chofer asignado
      document.getElementById("editarAsignadoChoferSemirremolque").value =
        registro[6] || "";
    } catch (error) {
      console.error("Error al llenar modal editar semirremolque:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: error.message || "No se pudieron cargar los datos para edición.",
      });
    }
  }

  function setupBotonesFlota() {
    // Botón editar
    $(document)
      .off("click", ".btn-editar-flota")
      .on("click", ".btn-editar-flota", async function () {
        const idFlota = $(this).data("id");
        try {
          const registro = await runGoogleFunction(
            "obtenerRegistroFlota",
            idFlota
          );
          if (registro) {
            llenarModalEditarFlota(registro);
            const modal = new bootstrap.Modal(
              document.getElementById("modalEditarFlota")
            );
            modal.show();
          } else {
            Swal.fire("Error", "Registro no encontrado", "error");
          }
        } catch (error) {
          console.error("Error al editar:", error);
          Swal.fire("Error", "No se pudo cargar el registro", "error");
        }
      });

    // Botón borrar
    $(document)
      .off("click", ".btn-borrar-flota")
      .on("click", ".btn-borrar-flota", async function () {
        const idFlota = $(this).data("id");

        const confirmacion = await Swal.fire({
          title: "¿Estás seguro?",
          text: `Se eliminará el registro con ID: ${idFlota}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Sí, borrar",
          cancelButtonText: "Cancelar",
        });

        if (confirmacion.isConfirmed) {
          try {
            showLoading("Eliminando...");
            await runGoogleFunction("borrarRegistroFlota", idFlota);

            Swal.fire({
              icon: "success",
              title: "Eliminado",
              text: "Registro eliminado correctamente",
              timer: 1500,
              showConfirmButton: false,
            });

            // 🔥 LIMPIAR CACHÉ y RECARGAR tabla
            cacheDatosPorModulo["Flota"] = null;
            cacheDatosPorModulo["Flota_headers"] = null;
            await loadTableData("Flota");
          } catch (error) {
            console.error("Error al borrar:", error);
            Swal.fire("Error", "No se pudo borrar el registro", "error");
          } finally {
            hideLoading();
          }
        }
      });
  }

  //Función botón Guardar Camios Editar Semirremolque
  document.getElementById("btnGuardarEditarSemirremolque").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

      try {
        const formData = getFormData("formEditarSemirremolque");

        const registroModificado = [
          Number(formData.idsemirremolque),
          formData.patentesemirremolque || "",
          formData.nrogensetsemirremolque || "",
          formData.tiposemirremolque || "",
          formData.añosemirremolque || "",
          formData.estadosemirremolque || "",
          formData.asignadochofersemirremolque || "",
          formData.observacionessemirremolque || "",
        ];

        const resultado = await runGoogleFunction(
          "actualizarRegistroSemirremolque",
          registroModificado
        );

        if (resultado === "success") {
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("modalEditarSemirremolque")
          );
          modal.hide();

          await Swal.fire({
            icon: "success",
            title: "Actualizado",
            text: "El registro fue actualizado correctamente",
            timer: 1500,
            showConfirmButton: false,
          });

          // 🔥 CORREGIDO: limpiar caché y recargar datos actualizados
          delete cacheDatosPorModulo["Semirremolque"];
          delete cacheDatosPorModulo["Semirremolque_headers"];
          await loadTableData("Semirremolque");
        } else {
          throw new Error("No se pudo actualizar el registro");
        }
      } catch (error) {
        console.error("❌ Error al actualizar semirremolque:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "Error al actualizar el semirremolque",
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  //Función Borrar Semirremolque

  $(document)
    .off("click", ".btn-borrar-semirremolque")
    .on("click", ".btn-borrar-semirremolque", function () {
      const idSemirremolque = $(this).data("id");

      Swal.fire({
        title: "¿Estás seguro?",
        text: `Se eliminará el semirremolque con ID: ${idSemirremolque}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await runGoogleFunction(
              "borrarRegistroSemirremolque",
              idSemirremolque
            );

            Swal.fire({
              icon: "success",
              title: "Eliminado",
              text: "Semirremolque eliminado correctamente",
              timer: 1500,
              showConfirmButton: false,
            });

            await loadTableData(currentSheetName);
          } catch (error) {
            console.error("Error al eliminar semirremolque:", error);
            Swal.fire("Error", "No se pudo eliminar el semirremolque", "error");
          }
        }
      });
    });

  //Validar chofer disponible en semirremolque
  async function validarChoferDisponible(choferSeleccionado, idActual = null) {
    const { datos } = await runGoogleFunction("getData", "Semirremolque");

    return !datos.some((row) => {
      const idRegistro = String(row[0]);
      const choferAsignado = (row[6] || "").trim().toLowerCase();
      return (
        choferAsignado === choferSeleccionado.trim().toLowerCase() &&
        idRegistro !== String(idActual)
      );
    });
  }

  // 🔵 Cargar lista de Choferes para editar Semirremolque
  async function cargarOpcionesChoferesEditar(idSemirremolqueActual) {
    const { datos: datosChoferes } = await runGoogleFunction(
      "getData",
      "Choferes"
    );
    const { datos: datosSemirremolque } = await runGoogleFunction(
      "getData",
      "Semirremolque"
    );

    const select = document.getElementById("editarAsignadoChoferSemirremolque");
    select.innerHTML = '<option value="">Seleccione chofer</option>';

    const choferesYaAsignados = datosSemirremolque
      .filter((row) => String(row[0]) !== String(idSemirremolqueActual)) // ⚠️ Excluir el actual
      .map((row) => row[6])
      .filter((nombre) => !!nombre && nombre.trim() !== "");

    const disponibles = datosChoferes.filter(
      (chofer) => chofer[1] && !choferesYaAsignados.includes(chofer[1])
    );

    disponibles.forEach((chofer) => {
      const option = document.createElement("option");
      option.value = chofer[1];
      option.textContent = chofer[1];
      select.appendChild(option);
    });
  }

  // Variable global para cachear los choferes una vez cargados
  let cacheChoferesParaSemirremolque = [];

  async function cargarOpcionesChoferes() {
    try {
      const { datos: datosChoferes } = await runGoogleFunction(
        "getData",
        "Choferes"
      );
      const { datos: datosSemirremolque } = await runGoogleFunction(
        "getData",
        "Semirremolque"
      );

      const select = document.getElementById(
        "inputAsignadoChoferSemirremolque"
      );
      select.innerHTML = '<option value="">Seleccione chofer</option>';

      // 🔵 Obtener nombres de choferes ya asignados a un semirremolque
      const choferesYaAsignados = datosSemirremolque
        .map((row) => row[6])
        .filter((nombre) => !!nombre && nombre.trim() !== "");

      // 🔵 Filtrar solo los choferes disponibles
      const choferesDisponibles = datosChoferes.filter((chofer) => {
        const nombre = chofer[1];
        return nombre && !choferesYaAsignados.includes(nombre);
      });

      // 🔵 Agregar al select solo los disponibles
      choferesDisponibles.forEach((chofer) => {
        const nombre = chofer[1];
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = nombre;
        select.appendChild(option);
      });
    } catch (error) {
      console.error("❌ Error al cargar opciones de choferes:", error);
      Swal.fire(
        "Error",
        "No se pudieron cargar los choferes disponibles",
        "error"
      );
    }
  }

  async function validarChoferDisponible(choferSeleccionado, idActual = null) {
    const { datos } = await runGoogleFunction("getData", "Semirremolque");

    return !datos.some((row) => {
      const idRegistro = String(row[0]);
      const choferAsignado = (row[6] || "").trim().toLowerCase();
      return (
        choferAsignado === choferSeleccionado.trim().toLowerCase() &&
        idRegistro !== String(idActual)
      );
    });
  }

  async function cargarOpcionesChoferesAgregar() {
    try {
      const { datos: datosChoferes } = await runGoogleFunction(
        "getData",
        "Choferes"
      );
      const { datos: datosSemirremolque } = await runGoogleFunction(
        "getData",
        "Semirremolque"
      );

      const select = document.getElementById(
        "inputAsignadoChoferSemirremolque"
      );
      select.innerHTML = '<option value="">Seleccione chofer</option>';

      // Obtener IDs de choferes ya asignados en Semirremolque
      const asignados = datosSemirremolque
        .map((row) => row[6])
        .filter((asignado) => asignado && asignado.trim() !== "");

      datosChoferes.forEach((chofer) => {
        if (chofer[1] && !asignados.includes(chofer[1])) {
          // Nombre en columna 1
          const option = document.createElement("option");
          option.value = chofer[1];
          option.textContent = chofer[1];
          select.appendChild(option);
        }
      });
    } catch (error) {
      console.error("Error cargando choferes disponibles:", error);
      Swal.fire(
        "Error",
        "No se pudieron cargar los choferes disponibles.",
        "error"
      );
    }
  }

  function validarFormularioAgregarSemirremolque() {
    const form = document.getElementById("formAgregarSemirremolque");
    let isValid = true;

    // Lista de campos obligatorios
    const camposRequeridos = [
      "inputPatenteSemirremolque",
      "inputNroGensetSemirremolque",
      "inputTipoSemirremolque",
      "inputAñoSemirremolque",
      "inputEstadoSemirremolque",
    ];

    camposRequeridos.forEach((id) => {
      const field = document.getElementById(id);
      if (!field || !field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    return isValid;
  }

  //------------------------------
  // Módulo Poliza
  //------------------------------

  let modoRenovacion = false;

  function calcularEstadoPoliza(fechaHasta) {
    const hoy = new Date();
    const hasta = new Date(fechaHasta);
    const diferencia = Math.ceil((hasta - hoy) / (1000 * 60 * 60 * 24));

    if (diferencia > 30) return "vigente";
    if (diferencia > 0 && diferencia <= 30) return "por vencer";
    return "vencida";
  }

  async function cargarPatentesPorTipo() {
    const tipo = document.getElementById("inputTipoPoliza").value;
    const selectPatente = document.getElementById("inputPatentePoliza");
    selectPatente.innerHTML = '<option value="">Cargando patentes...</option>';

    let datos = [];

    if (tipo === "Camión") {
      const { datos: flota } = await runGoogleFunction("getData", "Flota");
      datos = flota.map((row) => row[2]); // patente está en la columna 2
    } else if (tipo === "Semirremolque") {
      const { datos: semi } = await runGoogleFunction(
        "getData",
        "Semirremolque"
      );
      datos = semi.map((row) => row[1]); // patente en columna 1
    }

    selectPatente.innerHTML = '<option value="">Seleccione</option>';
    datos.forEach((patente) => {
      const opt = document.createElement("option");
      opt.value = patente;
      opt.textContent = patente;
      selectPatente.appendChild(opt);
    });
  }

  function calcularDiasRestantes(fechaHasta) {
    if (!fechaHasta) return "-";
    const hoy = new Date();
    const hasta = new Date(fechaHasta);
    const diferencia = Math.ceil((hasta - hoy) / (1000 * 60 * 60 * 24));
    return diferencia;
  }

  function determinarEstadoPoliza(dias) {
    if (dias > 30) return "vigente";
    if (dias > 0) return "por vencer";
    return "vencida";
  }

  //Botón Guardar Nueva Poliza
  document.getElementById("btnGuardarPoliza").onclick = async function () {
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...`;

    try {
      if (!validarFormularioAgregarPoliza()) {
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
      }
      const formData = getFormData("formAgregarPoliza");
      const idPoliza = await runGoogleFunction("generarIdPoliza");

      // 🔵 Función para formatear fecha a dd-mm-yyyy
      const formatearFecha = (fechaISO) => {
        if (!fechaISO || !fechaISO.includes("-")) return "";
        const [anio, mes, dia] = fechaISO.split("-");
        return `${dia.padStart(2, "0")}-${mes.padStart(2, "0")}-${anio}`;
      };

      const estadoCalculado = calcularEstadoPoliza(
        formData.vigenciahastapoliza
      );
      const diasRestantes = Math.ceil(
        (new Date(formData.vigenciahastapoliza) - new Date()) /
          (1000 * 60 * 60 * 24)
      );

      const registro = [
        idPoliza,
        formData.tipopoliza || "",
        formData.patentepoliza || "",
        formData.aseguradorapoliza || "",
        formData.codigopoliza || "",
        formatearFecha(formData.vigenciadesdepoliza),
        formatearFecha(formData.vigenciahastapoliza),
        formData.importepagadopoliza || "",
        formatearFecha(formData.fechapagopoliza),
        estadoCalculado,
        formData.observacionespoliza || "",
        diasRestantes,
        formData.urlpoliza || "",
      ];

      await runGoogleFunction("agregarRegistroPoliza", registro);

      // ✅ Si estamos renovando una póliza existente, marcarla como 'renovada'
      const form = document.getElementById("formAgregarPoliza");
      const idOriginal = form.getAttribute("data-renovar-id");
      if (idOriginal) {
        await runGoogleFunction("actualizarEstadoPolizaRenovada", idOriginal);
        form.removeAttribute("data-renovar-id");
      }

      $("#modalAgregarPoliza").modal("hide");

      await Swal.fire({
        icon: "success",
        title: "Guardado",
        text: "La póliza se ha guardado correctamente",
        timer: 1500,
        showConfirmButton: false,
      });

      cacheDatosPorModulo["Polizas"] = null;
      cacheDatosPorModulo["Polizas_headers"] = null;
      await loadTableData("Polizas");
      crearFiltrosPolizas();
    } catch (error) {
      console.error("❌ Error al guardar póliza:", error);
      Swal.fire({
        icon: "error",
        title: "Error",
        text: error.message || "Error al guardar póliza",
      });
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  function getPolizasColumnDefs(headers) {
    const columnDefs = [];

    // 🔵 Estado (columna 9) - badge estilo Flota
    columnDefs.push({
      targets: 9, // Columna Estado
      render: function (data) {
        const estado = (data || "").toLowerCase();
        let badgeClass = "";

        switch (estado) {
          case "vigente":
            badgeClass = "estado-disponible badge-estado-flota";
            break;
          case "por vencer":
            badgeClass = "estado-mantencion badge-estado-flota";
            break;
          case "vencida":
            badgeClass = "estado-robado badge-estado-flota";
            break;
          case "renovada":
            badgeClass = "bg-secondary text-white"; // 👈 Etiqueta gris
            break;
          default:
            badgeClass = "badge-estado-flota";
        }

        return `<span class="badge ${badgeClass}">${data}</span>`;
      },
    });

    // 🔵 Días por vencer (columna 11) - sin estilos adicionales
    columnDefs.push({
      targets: 11,
      render: function (data) {
        const dias = parseInt(data, 10);
        return isNaN(dias) ? data : `${dias} días`;
      },
    });

    // 🔵 Importe Pagado CLP (columna 7)
    columnDefs.push({
      targets: 7,
      render: function (data) {
        const num = Number(data);
        return isNaN(num) ? data : `CLP $${num.toLocaleString("es-CL")}`;
      },
    });

    // 🔵 Botones (última columna)
    columnDefs.push({
      targets: -1,
      orderable: false,
      render: (data, type, row) => {
        const estado = (row[9] || "").toLowerCase(); // Columna estado
        const mostrarRenovar = estado !== "renovada";

        return `
      <div class="d-flex justify-content-center gap-1">
        <button class="btn btn-sm btn-warning btn-editar-poliza" data-id="${
          row[0]
        }" title="Editar">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-sm btn-danger btn-borrar-poliza" data-id="${
          row[0]
        }" title="Eliminar">
          <i class="bi bi-trash"></i>
        </button>
        ${
          mostrarRenovar
            ? `<button class="btn btn-sm btn-info btn-renovar-poliza" data-id="${row[0]}" title="Renovar">
                <i class="bi bi-arrow-repeat"></i>
              </button>`
            : ""
        }
      </div>
    `;
      },
    });

    return columnDefs;
  }

  //Actualizar Patentes Camion, Vehículo, Semirremolque
  async function actualizarOpcionesPatente() {
    const tipo = document.getElementById("inputTipoPoliza").value;
    const selectPatente = document.getElementById("inputPatentePoliza");

    // 🔁 Limpiar opciones anteriores
    selectPatente.innerHTML =
      '<option value="">Seleccione una patente</option>';

    if (!tipo) return;

    let datos = [];
    let columnaPatente = 2; // Default para Flota

    try {
      if (tipo === "Camión" || tipo === "Vehículo") {
        const { datos: datosFlota } = await runGoogleFunction(
          "getData",
          "Flota"
        );
        columnaPatente = 2; // Patente en columna 2
        datos = datosFlota.filter((row) =>
          tipo === "Camión"
            ? row[1]?.toLowerCase().includes("camión")
            : row[1]?.toLowerCase().includes("vehículo")
        );
      } else if (tipo === "Semirremolque") {
        const { datos: datosSemi } = await runGoogleFunction(
          "getData",
          "Semirremolque"
        );
        columnaPatente = 1; // Patente en columna 1 en hoja Semirremolque
        datos = datosSemi;
      }

      // ✅ Agregar opciones sin duplicados
      const patentesUnicas = new Set();
      datos.forEach((row) => {
        const patente = row[columnaPatente]?.toUpperCase();
        if (patente && !patentesUnicas.has(patente)) {
          patentesUnicas.add(patente);
          const option = document.createElement("option");
          option.value = patente;
          option.textContent = patente;
          selectPatente.appendChild(option);
        }
      });
    } catch (error) {
      console.error("❌ Error al cargar patentes:", error);
      Swal.fire("Error", "No se pudieron cargar las patentes", "error");
    }
  }

  //Botones Editar - Eliminar - Renovar Poliza
  function setupBotonesPoliza() {
    // Botón EDITAR
    $(document)
      .off("click", ".btn-editar-poliza")
      .on("click", ".btn-editar-poliza", async function () {
        const id = $(this).data("id");

        try {
          const modal = new bootstrap.Modal(
            document.getElementById("modalEditarPoliza")
          );
          modal.show();

          document
            .getElementById("spinnerEditarPoliza")
            .classList.remove("d-none");
          document
            .getElementById("contenidoEditarPoliza")
            .classList.add("d-none");

          const registro = await runGoogleFunction("obtenerRegistroPoliza", id);
          if (!registro) {
            Swal.fire("Error", "No se encontró la póliza.", "error");
            return;
          }

          await llenarModalEditarPoliza(registro);

          document
            .getElementById("spinnerEditarPoliza")
            .classList.add("d-none");
          document
            .getElementById("contenidoEditarPoliza")
            .classList.remove("d-none");
        } catch (error) {
          console.error("Error al cargar póliza:", error);
          Swal.fire("Error", "No se pudo cargar la póliza.", "error");
        }
      });

    // Botón BORRAR
    $(document)
      .off("click", ".btn-borrar-poliza")
      .on("click", ".btn-borrar-poliza", async function () {
        const id = $(this).data("id");

        const confirmacion = await Swal.fire({
          title: "¿Estás seguro?",
          text: `Se eliminará la póliza con ID: ${id}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc3545",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Sí, borrar",
          cancelButtonText: "Cancelar",
        });

        if (confirmacion.isConfirmed) {
          try {
            await runGoogleFunction("borrarRegistroPoliza", id);
            await Swal.fire("¡Eliminada!", "La póliza fue borrada.", "success");
            cacheDatosPorModulo["Polizas"] = null;
            cacheDatosPorModulo["Polizas_headers"] = null;
            await loadTableData("Polizas");
            crearFiltrosPolizas();
          } catch (error) {
            console.error("Error al borrar póliza:", error);
            Swal.fire("Error", "No se pudo borrar la póliza.", "error");
          }
        }
      });

    // Botón RENOVAR
    $(document)
      .off("click", ".btn-renovar-poliza")
      .on("click", ".btn-renovar-poliza", async function () {
        const id = $(this).data("id");

        try {
          const original = await runGoogleFunction("obtenerRegistroPoliza", id);
          if (!original) {
            return Swal.fire("Error", "No se encontró la póliza", "error");
          }

          const modalAgregar = new bootstrap.Modal(
            document.getElementById("modalAgregarPoliza")
          );

          document.getElementById("modalAgregarPolizaLabel").textContent =
            "Renovar Póliza";
          document.getElementById(
            "btnGuardarPoliza"
          ).innerHTML = `<i class="bi bi-arrow-repeat"></i> Guardar Renovación`;
          document.getElementById("spinnerRenovarPoliza").style.display =
            "block";
          document.getElementById("contenidoFormularioPoliza").style.display =
            "none";

          modalAgregar.show();

          $("#modalAgregarPoliza").one("shown.bs.modal", async () => {
            const form = document.getElementById("formAgregarPoliza");
            const inputTipo = document.getElementById("inputTipoPoliza");
            const inputPatente = document.getElementById("inputPatentePoliza");

            inputTipo.value = original[1];
            inputTipo.disabled = true;

            await actualizarOpcionesPatente();

            await new Promise((resolve) => {
              const maxTiempo = 3000;
              const intervalo = 100;
              let tiempo = 0;

              const revisar = setInterval(() => {
                const opciones = [...inputPatente.options].map(
                  (opt) => opt.value
                );
                const existe = opciones.includes(original[2]);

                if (existe) {
                  inputPatente.value = original[2];
                  inputPatente.disabled = true;
                  clearInterval(revisar);
                  resolve();
                }

                tiempo += intervalo;
                if (tiempo >= maxTiempo) {
                  console.warn("⚠️ Patente no encontrada en el select.");
                  clearInterval(revisar);
                  resolve();
                }
              }, intervalo);
            });

            form.querySelector('[name="inputAseguradoraPoliza"]').value =
              original[3] || "";
            form.querySelector('[name="inputCodigoPoliza"]').value =
              original[4] || "";
            form.querySelector('[name="inputImportePagadoPoliza"]').value = "";
            form.querySelector('[name="inputFechaPagoPoliza"]').value = "";
            form.querySelector('[name="inputObservacionesPoliza"]').value = "";
            form.querySelector('[name="inputUrlPoliza"]').value = "";

            const hoy = new Date();
            const unAnioDespues = new Date();
            unAnioDespues.setFullYear(hoy.getFullYear() + 1);
            const formatoFecha = (d) => d.toISOString().split("T")[0];

            form.querySelector('[name="inputVigenciaDesdePoliza"]').value =
              formatoFecha(hoy);
            form.querySelector('[name="inputVigenciaHastaPoliza"]').value =
              formatoFecha(unAnioDespues);

            form.setAttribute("data-renovar-id", id);

            document.getElementById("spinnerRenovarPoliza").style.display =
              "none";
            document.getElementById("contenidoFormularioPoliza").style.display =
              "flex";
          });
        } catch (error) {
          console.error("❌ Error al renovar póliza:", error);
          Swal.fire("Error", "No se pudo preparar la renovación", "error");
        }
      });

    // Botón AGREGAR (modo normal)
    const btnAgregar = document.getElementById("btnAbrirModalAgregarPoliza");
    if (btnAgregar) {
      btnAgregar.addEventListener("click", () => {
        const form = document.getElementById("formAgregarPoliza");
        const modal = new bootstrap.Modal(
          document.getElementById("modalAgregarPoliza")
        );

        form.reset();
        form.removeAttribute("data-renovar-id");

        document.getElementById("modalAgregarPolizaLabel").textContent =
          "Agregar Nueva Póliza";
        document.getElementById(
          "btnGuardarPoliza"
        ).innerHTML = `<i class="bi bi-save"></i> Guardar Póliza`;

        document.getElementById("inputTipoPoliza").disabled = false;
        document.getElementById("inputPatentePoliza").disabled = false;

        document.getElementById("spinnerRenovarPoliza").style.display = "none";
        document.getElementById("contenidoFormularioPoliza").style.display =
          "flex";

        modal.show();
      });
    }

    // 🔁 Al cerrar el modal manualmente, restaurar estado
    $("#modalAgregarPoliza").on("hidden.bs.modal", () => {
      const form = document.getElementById("formAgregarPoliza");
      form.reset();
      form.removeAttribute("data-renovar-id");

      document.getElementById("modalAgregarPolizaLabel").textContent =
        "Agregar Nueva Póliza";
      document.getElementById(
        "btnGuardarPoliza"
      ).innerHTML = `<i class="bi bi-save"></i> Guardar Póliza`;

      document.getElementById("inputTipoPoliza").disabled = false;
      document.getElementById("inputPatentePoliza").disabled = false;

      document.getElementById("spinnerRenovarPoliza").style.display = "none";
      document.getElementById("contenidoFormularioPoliza").style.display =
        "flex";
    });
  }

  //LLenar modal Editar Poliza
  async function llenarModalEditarPoliza(registro) {
    document.getElementById("editarIdPoliza").value = registro[0];
    document.getElementById("editarTipoPoliza").value = registro[1];

    // 🔄 Cargar opciones de patente según tipo seleccionado
    await actualizarOpcionesPatenteEditar();

    // ✅ Asignar la patente después que el select se haya llenado
    document.getElementById("editarPatentePoliza").value = registro[2] || "";

    document.getElementById("editarAseguradoraPoliza").value = registro[3];
    document.getElementById("editarCodigoPoliza").value = registro[4];
    document.getElementById("editarVigenciaDesdePoliza").value =
      formatearFechaParaInput(registro[5]);
    document.getElementById("editarVigenciaHastaPoliza").value =
      formatearFechaParaInput(registro[6]);
    document.getElementById("editarImportePagadoPoliza").value = limpiarMoneda(
      registro[7]
    );
    document.getElementById("editarFechaPagoPoliza").value =
      formatearFechaParaInput(registro[8]);
    document.getElementById("editarObservacionesPoliza").value =
      registro[10] || "";
    document.getElementById("editarUrlPoliza").value = registro[12] || "";
  }

  //Evento Botón Guardar Editar Poliza
  document.getElementById("btnGuardarEditarPoliza").onclick =
    async function () {
      const btn = this;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...';

      try {
        const formData = getFormData("formEditarPoliza");

        const estadoCalculado = calcularEstadoPoliza(
          formData.vigenciahastapoliza
        );
        const diasRestantes = Math.ceil(
          (new Date(formData.vigenciahastapoliza) - new Date()) /
            (1000 * 60 * 60 * 24)
        );

        const registroModificado = [
          Number(formData.idpoliza),
          formData.tipopoliza || "",
          formData.patentepoliza || "",
          formData.aseguradorapoliza || "",
          formData.codigopoliza || "",
          formData.vigenciadesdepoliza || "",
          formData.vigenciahastapoliza || "",
          formData.importepagadopoliza || "",
          formData.fechapagopoliza || "",
          estadoCalculado,
          formData.observacionespoliza || "",
          diasRestantes,
          formData.urlpoliza || "",
        ];

        const resultado = await runGoogleFunction(
          "actualizarRegistroPoliza",
          registroModificado
        );

        if (resultado === "success") {
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("modalEditarPoliza")
          );
          modal.hide();

          await Swal.fire({
            icon: "success",
            title: "Actualizado",
            text: "La póliza fue actualizada correctamente",
            timer: 1500,
            showConfirmButton: false,
          });

          cacheDatosPorModulo["Polizas"] = null;
          cacheDatosPorModulo["Polizas_headers"] = null;
          await loadTableData("Polizas");
          crearFiltrosPolizas();
        } else {
          throw new Error("No se pudo actualizar la póliza.");
        }
      } catch (error) {
        console.error("Error al guardar cambios de póliza:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.message || "Error al actualizar póliza.",
        });
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };

  //Funcion para actualizar opciones Patente Editar
  async function actualizarOpcionesPatenteEditar() {
    const tipo = document.getElementById("editarTipoPoliza").value;
    const select = document.getElementById("editarPatentePoliza");

    // Limpiar opciones anteriores
    select.innerHTML = '<option value="">Seleccione patente</option>';

    if (!tipo) return;

    let datos = [];
    let indicePatente = 2; // valor por defecto (pero se actualiza según el tipo)

    if (tipo === "Camión" || tipo === "Vehículo") {
      const { datos: datosFlota } = await runGoogleFunction("getData", "Flota");
      datos = datosFlota.filter((row) => {
        const tipoUnidad = row[1]?.toLowerCase();
        return tipo === "Camión"
          ? tipoUnidad.includes("camión")
          : tipoUnidad.includes("vehículo");
      });
      indicePatente = 2; // Patente está en la columna 2 de Flota
    } else if (tipo === "Semirremolque") {
      const { datos: datosSemi } = await runGoogleFunction(
        "getData",
        "Semirremolque"
      );
      datos = datosSemi;
      indicePatente = 1; // ✅ Patente está en la columna 1 en Semirremolque
    }

    const patentesUnicas = [...new Set(datos.map((row) => row[indicePatente]))];

    patentesUnicas.forEach((patente) => {
      if (patente && patente.trim()) {
        const option = document.createElement("option");
        option.value = patente.trim();
        option.textContent = patente.trim();
        select.appendChild(option);
      }
    });
  }

  function validarFormularioAgregarPoliza() {
    const form = document.getElementById("formAgregarPoliza");
    let isValid = true;

    // Lista de campos obligatorios por ID
    const camposObligatorios = [
      "inputTipoPoliza",
      "inputPatentePoliza",
      "inputAseguradoraPoliza",
      "inputCodigoPoliza",
      "inputVigenciaDesdePoliza",
      "inputVigenciaHastaPoliza",
    ];

    // Validar los campos requeridos
    camposObligatorios.forEach((id) => {
      const field = document.getElementById(id);
      if (!field.value.trim()) {
        field.classList.add("is-invalid");
        isValid = false;
      } else {
        field.classList.remove("is-invalid");
      }
    });

    return isValid;
  }

  //Btn renovar poliza
  // Btn renovar poliza
  const btnRenovar = document.getElementById("btnRenovarPoliza");
  if (btnRenovar) {
    btnRenovar.addEventListener("click", async () => {
      try {
        modoRenovacion = true;

        const formData = getFormData("formEditarPoliza");
        const datosParaRenovar = {
          tipopoliza: formData.tipopoliza,
          patentepoliza: formData.patentepoliza,
          aseguradorapoliza: formData.aseguradorapoliza,
          codigopoliza: formData.codigopoliza,
          vigenciadesdepoliza: "",
          vigenciahastapoliza: "",
          importepagadopoliza: "",
          fechapagopoliza: "",
          observacionespoliza: "",
          urlpoliza: "",
        };

        const modalEditar = bootstrap.Modal.getInstance(
          document.getElementById("modalEditarPoliza")
        );
        modalEditar.hide();

        const modalAgregar = new bootstrap.Modal(
          document.getElementById("modalAgregarPoliza")
        );

        // ✅ Cambiar texto en modo renovación
        document.getElementById("modalAgregarPolizaLabel").textContent =
          "Renovar Póliza";
        document.getElementById(
          "btnGuardarPoliza"
        ).innerHTML = `<i class="bi bi-arrow-repeat"></i> Guardar Renovación`;

        modalAgregar.show();

        setTimeout(() => {
          const hoy = new Date();
          const yyyy = hoy.getFullYear();
          const mm = String(hoy.getMonth() + 1).padStart(2, "0");
          const dd = String(hoy.getDate()).padStart(2, "0");
          const fechaHoy = `${yyyy}-${mm}-${dd}`;

          const unAnioDespues = new Date(hoy);
          unAnioDespues.setFullYear(hoy.getFullYear() + 1);
          const fechaFin = `${unAnioDespues.getFullYear()}-${String(
            unAnioDespues.getMonth() + 1
          ).padStart(2, "0")}-${String(unAnioDespues.getDate()).padStart(
            2,
            "0"
          )}`;

          document.getElementById("inputTipoPoliza").disabled = true;
          document.getElementById("inputPatentePoliza").disabled = true;

          Object.entries(datosParaRenovar).forEach(([key, value]) => {
            const input = document.querySelector(
              `#formAgregarPoliza [name="input${
                key.charAt(0).toUpperCase() + key.slice(1)
              }"]`
            );
            if (input) {
              if (key === "vigenciadesdepoliza") input.value = fechaHoy;
              else if (key === "vigenciahastapoliza") input.value = fechaFin;
              else input.value = value;
            }
          });
        }, 250);
      } catch (error) {
        console.error("❌ Error al preparar renovación:", error);
        Swal.fire("Error", "No se pudo renovar la póliza", "error");
      }
    });
  }

  // 🔁 Restaurar texto del modal al cerrarlo
  document
    .getElementById("modalAgregarPoliza")
    .addEventListener("hidden.bs.modal", () => {
      if (modoRenovacion) {
        document.getElementById("modalAgregarPolizaLabel").textContent =
          "Agregar Nueva Póliza";
        document.getElementById(
          "btnGuardarPoliza"
        ).innerHTML = `<i class="bi bi-save"></i> Guardar Póliza`;
        modoRenovacion = false;
      }
    });

  function crearFiltrosPolizas() {
    const contenedor = document.getElementById("filtros-polizas");
    const datos = cacheDatosPorModulo["Polizas"] || [];

    // Contar estados
    const conteo = {
      vigente: 0,
      "por vencer": 0,
      vencida: 0,
      renovada: 0,
    };

    datos.forEach((row) => {
      const estado = (row[9] || "").toLowerCase(); // columna estado
      if (conteo.hasOwnProperty(estado)) conteo[estado]++;
    });

    const total = datos.length;

    contenedor.innerHTML = `
    <div class="d-flex flex-wrap justify-content-center gap-2">
      <button id="btnFiltroPolizaTodos" class="btn btn-outline-primary btn-sm">Todas (${total})</button>
      <button id="btnFiltroPolizaVigente" class="btn btn-outline-success btn-sm">Vigente (${conteo.vigente})</button>
      <button id="btnFiltroPolizaPorVencer" class="btn btn-outline-warning btn-sm">Por Vencer (${conteo["por vencer"]})</button>
      <button id="btnFiltroPolizaVencida" class="btn btn-outline-danger btn-sm">Vencida (${conteo.vencida})</button>
      <button id="btnFiltroPolizaRenovada" class="btn btn-outline-secondary btn-sm">Renovada (${conteo.renovada})</button>
    </div>
  `;
    contenedor.style.display = "flex";

    // Event listeners para filtros
    document.getElementById("btnFiltroPolizaTodos").onclick = () =>
      aplicarFiltroPoliza("");
    document.getElementById("btnFiltroPolizaVigente").onclick = () =>
      aplicarFiltroPoliza("vigente");
    document.getElementById("btnFiltroPolizaPorVencer").onclick = () =>
      aplicarFiltroPoliza("por vencer");
    document.getElementById("btnFiltroPolizaVencida").onclick = () =>
      aplicarFiltroPoliza("vencida");
    document.getElementById("btnFiltroPolizaRenovada").onclick = () =>
      aplicarFiltroPoliza("renovada");
  }

  function aplicarFiltroPoliza(estado) {
    const tabla = $("#tablaPrueba").DataTable();
    const columnaEstado = 9; // Ajusta si cambia

    tabla.column(columnaEstado).search(estado, true, false).draw();
  }

  //------------------------------
  // Módulo Viajes
  //------------------------------

  // Agregar Nuevo Viaje

  document.getElementById("btnGuardarViaje").onclick = async function () {
  const btn = this;
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...`;

  try {
    const form = document.getElementById("formAgregarViaje");
    const formData = getFormData("formAgregarViaje");

    // ✅ Validación personalizada de campos requeridos
    const camposRequeridos = {
      tipoviaje: "Tipo de viaje",
      clienteviaje: "Cliente",
      origenviaje: "Origen",
      destinoviaje: "Destino",
      empresaviaje: "Empresa",
      conductorviaje: "Conductor",
      fechasalidaviaje: "Fecha de salida",
    };

    for (const key in camposRequeridos) {
      if (!formData[key] || !formData[key].trim()) {
        await Swal.fire("Campo requerido", `Debes completar el campo: ${camposRequeridos[key]}`, "warning");
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
      }
    }

    // 🔴 Validar que el conductor no esté ya en un viaje "en ruta"
    const conductorDisponible = await validarConductorDisponibleParaViaje(formData.conductorviaje);
    if (!conductorDisponible) {
      await Swal.fire("Conductor ocupado", "Este conductor ya tiene un viaje en ruta.", "warning");
      btn.disabled = false;
      btn.innerHTML = originalText;
      return;
    }

    // 🔢 Generar ID (V001, V002...)
    const numero = await runGoogleFunction("generarIdViaje");
    const idViaje = `V${numero.toString().padStart(3, "0")}`;

    const fechaSalida = formatearFecha(formData.fechasalidaviaje);
    const fechaLlegada = formatearFecha(formData.fechallegadaviaje);
    const estado = fechaLlegada ? "realizado" : "en ruta";

    const registro = [
      idViaje,
      fechaSalida || "",
      fechaLlegada || "",
      formData.tipoviaje || "",
      formData.clienteviaje || "",
      formData.origenviaje || "",
      formData.destinoviaje || "",
      formData.empresaviaje || "",
      formData.conductorviaje || "",
      (formData.contenedorviaje || "").toUpperCase(),
      formData.guiaviaje || "",
      formData.facturaviaje || "",
      estado,
    ];

    await runGoogleFunction("agregarRegistroViaje", registro);

    const modal = bootstrap.Modal.getInstance(document.getElementById("modalAgregarViaje"));
    modal.hide();

    await Swal.fire({
      icon: "success",
      title: "Guardado",
      text: "El viaje fue registrado correctamente.",
      timer: 1500,
      showConfirmButton: false,
    });

    cacheDatosPorModulo["Viajes"] = null;
    cacheDatosPorModulo["Viajes_headers"] = null;
    await loadTableData("Viajes");
  } catch (error) {
    console.error("❌ Error al guardar viaje:", error);
    Swal.fire("Error", error.message || "No se pudo guardar el viaje", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
};

  function getViajesColumnDefs(headers) {
    const columnDefs = [];

    // Estado como badge (columna 12)
    columnDefs.push({
      targets: 12,
      render: function (data) {
        const estado = (data || "").toLowerCase();
        const clase =
          estado === "realizado"
            ? "badge bg-success"
            : estado === "en ruta"
            ? "badge bg-warning text-dark"
            : "badge bg-secondary";
        return `<span class="${clase}">${data}</span>`;
      },
    });

    // Botones de acción
    columnDefs.push({
      targets: -1,
      orderable: false,
      render: function (data, type, row) {
        return `
        <div class="d-flex justify-content-center gap-1">
          <button class="btn btn-sm btn-primary btn-ver-mas-viaje" data-id="${row[0]}" title="Ver más">
            <i class="bi bi-search"></i>
          </button>
          <button class="btn btn-sm btn-warning btn-editar-viaje" data-id="${row[0]}" title="Editar">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm btn-danger btn-borrar-viaje" data-id="${row[0]}" title="Eliminar">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      `;
      },
    });

    return columnDefs;
  }

  // Botones Viaje
  function setupBotonesViaje() {
    // Ver más
    $(document)
      .off("click", ".btn-ver-mas-viaje")
      .on("click", ".btn-ver-mas-viaje", async function () {
        const id = $(this).data("id");
        const datosViaje = await runGoogleFunction("obtenerRegistroViaje", id);
        if (!datosViaje) {
          return Swal.fire("Error", "No se encontró el viaje", "error");
        }

        const conductor = datosViaje[8];
        const chofer =
          (await runGoogleFunction("buscarChoferPorNombre", conductor)) || [];

        const html = `
        <strong>Fecha Salida:</strong> ${datosViaje[1]}<br/>
        <strong>Fecha Llegada:</strong> ${datosViaje[2] || "-"}<br/>
        <strong>Tipo:</strong> ${datosViaje[3]}<br/>
        <strong>Contenedor:</strong> ${datosViaje[9]}<br/>
        <strong>Guía:</strong> ${datosViaje[10]}<br/>
        <strong>Factura:</strong> ${datosViaje[11]}<br/><hr>
        <strong>Chofer:</strong> ${conductor || "-"}<br/>
        <strong>Licencia:</strong> ${chofer[3] || "-"}<br/>
        <strong>Flota asignada:</strong> ${chofer[10] || "-"}<br/>
      `;

        await Swal.fire({
          icon: "info",
          title: `Detalles del Viaje ${datosViaje[0]}`,
          html: html,
        });
      });

    // Editar
    $(document)
      .off("click", ".btn-editar-viaje")
      .on("click", ".btn-editar-viaje", async function () {
        const id = $(this).data("id");

        try {
          const registro = await runGoogleFunction("obtenerRegistroViaje", id);
          if (!registro)
            return Swal.fire("Error", "No se encontró el viaje", "error");

          await llenarModalEditarViaje(registro);
          const modal = new bootstrap.Modal(
            document.getElementById("modalEditarViaje")
          );
          modal.show();
        } catch (error) {
          console.error("❌ Error al cargar viaje:", error);
          Swal.fire("Error", "No se pudo cargar el viaje para editar", "error");
        }
      });

    // Borrar
    $(document)
      .off("click", ".btn-borrar-viaje")
      .on("click", ".btn-borrar-viaje", async function () {
        const id = $(this).data("id");

        const confirm = await Swal.fire({
          title: "¿Eliminar viaje?",
          text: `Se eliminará el viaje ${id}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Sí, borrar",
        });

        if (confirm.isConfirmed) {
          await runGoogleFunction("borrarRegistroViaje", id);
          await Swal.fire(
            "Eliminado",
            "Viaje eliminado correctamente",
            "success"
          );
          cacheDatosPorModulo["Viajes"] = null;
          cacheDatosPorModulo["Viajes_headers"] = null;
          await loadTableData("Viajes");
        }
      });
  }

  async function cargarOpcionesViajeDesdeInfo() {
    try {
      const { datos } = await runGoogleFunction("getData", "Info");
      if (!datos || datos.length === 0) return;

      // Extraer encabezados
      const encabezados = datos[0];

      // Crear un objeto donde cada encabezado es una clave con sus valores
      const infoData = {};
      encabezados.forEach((col, index) => {
        infoData[col] = datos
          .slice(1)
          .map((row) => row[index])
          .filter((val) => val); // Eliminar valores vacíos
      });

      // Cargar en cada select
      cargarOpcionesSelect("inputClienteViaje", infoData["Cliente"]);
      cargarOpcionesSelect("inputEmpresaViaje", infoData["Empresa"]);
      cargarOpcionesSelect("inputOrigenViaje", infoData["Ubicación"]);
      cargarOpcionesSelect("inputDestinoViaje", infoData["Ubicación"]);
      cargarOpcionesSelect("editarClienteViaje", infoData["Cliente"]);
      cargarOpcionesSelect("editarEmpresaViaje", infoData["Empresa"]);
      cargarOpcionesSelect("editarOrigenViaje", infoData["Ubicación"]);
      cargarOpcionesSelect("editarDestinoViaje", infoData["Ubicación"]);
    } catch (error) {
      console.error("❌ Error al cargar opciones desde Info:", error);
      Swal.fire("Error", "No se pudieron cargar las opciones de Info", "error");
    }
  }

  function cargarOpcionesSelect(idSelect, valores) {
    const select = document.getElementById(idSelect);
    if (!select) return;

    select.innerHTML = '<option value="">Seleccione</option>';
    [...new Set(valores)].forEach((valor) => {
      const option = document.createElement("option");
      option.value = valor;
      option.textContent = valor;
      select.appendChild(option);
    });
  }

  // 🔄 Cargar conductores con estado "disponible"
  async function cargarConductoresDisponiblesViaje(idViajeActual = null) {
    const { datos: choferes } = await runGoogleFunction("getData", "Choferes");
    const { datos: viajes } = await runGoogleFunction("getData", "Viajes");

    // 🔴 Obtener conductores ya asignados a viajes en ruta
    const conductoresEnRuta = viajes
      .filter((v) => v[12]?.toLowerCase() === "en ruta")
      .filter((v) => v[0] !== idViajeActual) // Excluir el viaje actual si es edición
      .map((v) => v[8]); // Nombre del conductor

    const disponibles = choferes.filter((c) => {
      const estado = (c[9] || "").toLowerCase();
      const nombre = c[1];
      return estado === "disponible" && !conductoresEnRuta.includes(nombre);
    });

    const selectAgregar = document.getElementById("inputConductorViaje");
    const selectEditar = document.getElementById("editarConductorViaje");

    [selectAgregar, selectEditar].forEach((select) => {
      if (!select) return;
      select.innerHTML = '<option value="">Seleccione</option>';

      disponibles.forEach((chofer) => {
        const option = document.createElement("option");
        option.value = chofer[1];
        option.textContent = chofer[1];
        select.appendChild(option);
      });
    });
  }

  async function llenarSelectsViaje(tipo = "agregar") {
    await cargarDatosInfo();
    const datos = cacheDatosPorModulo["Info"];

    if (!datos || datos.length === 0) {
      console.warn("⚠️ No se encontraron datos en la hoja Info.");
      return;
    }

    console.log("📄 Datos de hoja Info:", datos); // ✅

    const encabezados = ["Cliente", "Empresa", "Ubicación"]; // ⚠️ Escríbelos aquí manualmente en el orden exacto

    const columnas = {
      cliente: [],
      empresa: [],
      ubicacion: [],
    };

    datos.forEach((fila) => {
      columnas.cliente.push(fila[0]);
      columnas.empresa.push(fila[1]);
      columnas.ubicacion.push(fila[2]);
    });

    const campos = {
      tipo: columnas["tipo"] || [],
      cliente: columnas["cliente"] || [],
      empresa: columnas["empresa"] || [],
      ubicacion: columnas["ubicacion"] || [],
      conductor: columnas["conductor"] || [],
    };

    const sufijo = tipo === "editar" ? "Editar" : "Agregar";

    const selects = {
      cliente: document.getElementById(
        tipo === "editar" ? "editarClienteViaje" : "inputClienteViaje"
      ),
      empresa: document.getElementById(
        tipo === "editar" ? "editarEmpresaViaje" : "inputEmpresaViaje"
      ),
      origen: document.getElementById(
        tipo === "editar" ? "editarOrigenViaje" : "inputOrigenViaje"
      ),
      destino: document.getElementById(
        tipo === "editar" ? "editarDestinoViaje" : "inputDestinoViaje"
      ),
      conductor: document.getElementById(
        tipo === "editar" ? "editarConductorViaje" : "inputConductorViaje"
      ),
    };

    for (const key in selects) {
      const select = selects[key];
      if (!select) continue;
      const valores =
        key === "origen" || key === "destino" ? campos.ubicacion : campos[key];

      select.innerHTML = `<option value="">Seleccione</option>`;
      valores.forEach((val) => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }
  }

  //Función llenar Modal Editar Viaje
  async function llenarModalEditarViaje(registro) {
    // registro = [ID, FechaSalida, FechaLlegada, Tipo, Cliente, Origen, Destino, Empresa, Conductor, Contenedor, Guía, Factura, Estado]
    document.getElementById("editarIdViaje").value = registro[0];
    document.getElementById("editarFechaSalidaViaje").value =
      formatearFechaParaInput(registro[1]);
    document.getElementById("editarFechaLlegadaViaje").value =
      formatearFechaParaInput(registro[2]);

    await llenarSelectsViaje("editar");
    await cargarConductoresDisponiblesViaje(); // Muestra todos disponibles + actual

    document.getElementById("editarTipoViaje").value = registro[3];
    document.getElementById("editarClienteViaje").value = registro[4];
    document.getElementById("editarOrigenViaje").value = registro[5];
    document.getElementById("editarDestinoViaje").value = registro[6];
    document.getElementById("editarEmpresaViaje").value = registro[7];
    document.getElementById("editarConductorViaje").value = registro[8];
    document.getElementById("editarContenedorViaje").value = registro[9];
    document.getElementById("editarGuiaViaje").value = registro[10];
    document.getElementById("editarFacturaViaje").value = registro[11];
  }

  //Boton Guardar Editar Viajes
  document.getElementById("btnGuardarEditarViaje").onclick = async function () {
    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> Guardando...`;

    try {
      const formData = getFormData("formEditarViaje");

      const fechaSalida = formatearFecha(formData.fechasalidaviaje);
      const fechaLlegada = formatearFecha(formData.fechallegadaviaje);
      const estado = fechaLlegada ? "realizado" : "en ruta";

      const registroModificado = [
        formData.idviaje,
        fechaSalida || "",
        fechaLlegada || "",
        formData.tipoviaje || "",
        formData.clienteviaje || "",
        formData.origenviaje || "",
        formData.destinoviaje || "",
        formData.empresaviaje || "",
        formData.conductorviaje || "",
        (formData.contenedorviaje || "").toUpperCase(),
        formData.guiaviaje || "",
        formData.facturaviaje || "",
        estado,
      ];

      const resultado = await runGoogleFunction(
        "actualizarRegistroViaje",
        registroModificado
      );

      if (resultado === "success") {
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("modalEditarViaje")
        );
        modal.hide();

        await Swal.fire({
          icon: "success",
          title: "Actualizado",
          text: "El viaje fue actualizado correctamente.",
          timer: 1500,
          showConfirmButton: false,
        });

        cacheDatosPorModulo["Viajes"] = null;
        cacheDatosPorModulo["Viajes_headers"] = null;
        await loadTableData("Viajes");
      } else {
        throw new Error("No se pudo actualizar el viaje");
      }
    } catch (error) {
      console.error("❌ Error al actualizar viaje:", error);
      Swal.fire(
        "Error",
        error.message || "Error al actualizar el viaje",
        "error"
      );
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  async function validarConductorDisponibleParaViaje(
    nombreConductor,
    idViajeActual = null
  ) {
    const { datos } = await runGoogleFunction("getData", "Viajes");

    return !datos.some((row) => {
      const id = row[0];
      const conductor = row[8];
      const estado = (row[12] || "").toLowerCase();

      return (
        conductor === nombreConductor &&
        estado === "en ruta" &&
        id !== idViajeActual // permite editar su propio viaje
      );
    });
  }
</script>
